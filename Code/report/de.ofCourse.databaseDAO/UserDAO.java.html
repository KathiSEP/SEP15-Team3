<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>UserDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">C:\Users\blacky\Documents\GitHub\SEP15-Team3\Code</a> &gt; <a href="index.source.html" class="el_package">de.ofCourse.databaseDAO</a> &gt; <span class="el_source">UserDAO.java</span></div><h1>UserDAO.java</h1><pre class="source lang-java linenums">/**
 * This package represents the Data Access Objects of the ofCourse system.
 */
package de.ofCourse.databaseDAO;

import java.io.IOException;
import java.io.InputStream;
import java.math.BigInteger;
import java.security.SecureRandom;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import javax.servlet.http.Part;

import de.ofCourse.exception.InvalidDBTransferException;
import de.ofCourse.model.Activation;
import de.ofCourse.model.Address;
import de.ofCourse.model.Course;
import de.ofCourse.model.PaginationData;
import de.ofCourse.model.Salutation;
import de.ofCourse.model.User;
import de.ofCourse.model.UserRole;
import de.ofCourse.model.UserStatus;
import de.ofCourse.system.Connection;
import de.ofCourse.system.LogHandler;
import de.ofCourse.system.Transaction;

/**
 * Provides methods for transactions with the users stored in the database such
 * as creating, retrieving, updating or deleting users. Also retrieves a course
 * leader's list of courses.
 * 
 * &lt;p&gt;
 * Each method has a Transaction parameter, which contains the SQL connection to
 * the database, in order to assure that multiple, consecutive method calls
 * within a certain method use the same connection.
 * &lt;/p&gt;
 * 
 * &lt;p&gt;
 * This class is required in the business logic of the system, more precisely in
 * the ManagedBeans of the package &lt;code&gt;de.ofCourse.action&lt;/code&gt;.
 * &lt;/p&gt;
 * 
 */
<span class="nc" id="L51">public class UserDAO {</span>

    /**
     * The SQL Command to get all Users
     */
    private final static String ALL_USERS = &quot;SELECT * FROM \&quot;users\&quot; &quot; +
    		&quot;ORDER BY %s %s LIMIT ? OFFSET ?&quot;;

    /**
     * The SQL Command to get all Users with this name
     */
    private final static String GET_USERS_BY_NAME = &quot;SELECT * FROM \&quot;users\&quot; &quot; +
    		&quot;WHERE NAME = ? ORDER BY %s %s LIMIT ? OFFSET ?&quot;;

    /**
     * The SQL Command to get User by Mail
     */
    private final static String GET_USER_BY_EMAIL = &quot;SELECT * FROM \&quot;users\&quot; &quot; +
    		&quot;WHERE EMAIL = ? ORDER BY %s %s LIMIT ? OFFSET ?&quot;;

    /**
     * The SQL Command to get User by Nickname
     */
    private final static String GET_USER_BY_NICKNAME = &quot;SELECT * &quot; +
    		&quot;FROM \&quot;users\&quot; WHERE NICKNAME = ? ORDER BY %s %s LIMIT ? OFFSET ?&quot;;

    /**
     * Returns the password salt of a user assigned to the passed user name.
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param username
     *            the user's name
     * @return the user's password salt
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * 
     * @author Katharina H�lzl
     */
    public static String getPWSalt(Transaction trans, String username)
	    throws InvalidDBTransferException {

<span class="fc" id="L94">	String pwSalt = &quot;&quot;;</span>

	// Prepare SQL- Request and database connection.
<span class="fc" id="L97">	Connection connection = (Connection) trans;</span>
<span class="fc" id="L98">	java.sql.Connection conn = connection.getConn();</span>

	// database request
<span class="fc" id="L101">	String sql = &quot;SELECT pw_salt &quot;</span>
	           + &quot;FROM \&quot;users\&quot; &quot;
	           + &quot;WHERE nickname=?&quot;;

	// catch potential SQL-Injection
<span class="fc" id="L106">	try (PreparedStatement pS = conn.prepareStatement(sql)){</span>
<span class="fc" id="L107">	     pS.setString(1, username);</span>
	     
	    // execute preparedStatement, return resultSet as a list
	    // (here one entry in the list because the user name is unique)
<span class="fc" id="L111">	    try (ResultSet res = pS.executeQuery()){</span>

        	    // execute next entry, return true if there is another 
	            //entry, else false.
<span class="fc bfc" id="L115" title="All 2 branches covered.">                    if (res.next()) {</span>
                        // Fill the id with the associated value from the 
                        // database.
<span class="fc" id="L118">                	pwSalt = res.getString(&quot;pw_salt&quot;);</span>
<span class="fc" id="L119">                	} else {</span>
<span class="fc" id="L120">                		pwSalt = null;</span>
                	}
<span class="pc bpc" id="L122" title="6 of 8 branches missed.">	    }  catch (SQLException e) {</span>
<span class="fc" id="L123">	        throw new SQLException();</span>
	    }
	    
<span class="pc bpc" id="L126" title="4 of 8 branches missed.">	} catch (SQLException e) {</span>
<span class="fc" id="L127">	    throw new InvalidDBTransferException(</span>
<span class="fc" id="L128">	                                &quot;Error occured during getPWSalt&quot;, e);</span>
	}

<span class="fc" id="L131">	return pwSalt;</span>
    }

    /**
     * Checks if the inserted mail address already exists in the database.
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param email
     *            inserted e-mail
     * @return true if the mail address already exists in the system, else
     *         return false
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * 
     * @author Katharina H�lzl
     */
    public static boolean emailExists(Transaction trans, String email)
	    throws InvalidDBTransferException {
        
<span class="fc" id="L152">	boolean exists = false;</span>

	// prepare SQL- request and database connection.
<span class="fc" id="L155">	Connection connection = (Connection) trans;</span>
<span class="fc" id="L156">	java.sql.Connection conn = connection.getConn();</span>

<span class="fc" id="L158">	String sql = &quot;SELECT id &quot;</span>
	           + &quot;FROM \&quot;users\&quot; &quot;
	           + &quot;WHERE email=?&quot;;
	
	// catch potential SQL-Injection
<span class="fc" id="L163">	try (PreparedStatement pS = conn.prepareStatement(sql)) {</span>
<span class="fc" id="L164">	    pS.setString(1, email);</span>

	    // execute preparedStatement, return resultSet as a list
	    // (here one entry in the list because the email is unique)
<span class="fc" id="L168">	    try(ResultSet res = pS.executeQuery()){</span>

        	    // execute next entry, return true if there is another 
        	    // entry, else false.
<span class="fc bfc" id="L172" title="All 2 branches covered.">        	    if (res.next()) {</span>
<span class="fc" id="L173">        		exists = true;</span>
<span class="fc" id="L174">        	    } else {</span>
<span class="fc" id="L175">        		exists = false;</span>
        	    }
        	    
<span class="pc bpc" id="L178" title="7 of 8 branches missed.">	    } catch (SQLException e) {</span>
<span class="nc" id="L179">                throw new SQLException();</span>
            }
<span class="pc bpc" id="L181" title="7 of 8 branches missed.">	} catch (SQLException e) {</span>
<span class="nc" id="L182">	    throw new InvalidDBTransferException(</span>
<span class="nc" id="L183">	                                &quot;Error occured during emailExists&quot;, e);</span>
	}
<span class="fc" id="L185">	return exists;</span>
    }

    /**
     * Checks whether or not the passed nickname is already in use by another
     * user.
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param nickName
     *               the passed nickname
     * @return true, if the nickname is already taken, false otherwise
     * 
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * 
     * @author Patrick Cretu
     */
    public static boolean nickTaken(Transaction trans, String nickname)
	    throws InvalidDBTransferException {
    	
<span class="fc" id="L207">		boolean exists = true;</span>
<span class="fc" id="L208">		Connection connection = (Connection) trans;</span>
<span class="fc" id="L209">		java.sql.Connection conn = connection.getConn();</span>
		int check;
<span class="fc" id="L211">		String query = &quot;SELECT COUNT(*) FROM \&quot;users\&quot; WHERE nickname = ?&quot;;</span>
	
<span class="fc" id="L213">		try (PreparedStatement stmt = conn.prepareStatement(query)) {</span>
<span class="fc" id="L214">		    stmt.setString(1, nickname);</span>
		    
<span class="fc" id="L216">		    try (ResultSet rst = stmt.executeQuery()) {</span>
<span class="fc" id="L217">		    	rst.next();</span>
<span class="fc" id="L218">		    	check = rst.getInt(1);</span>
<span class="fc bfc" id="L219" title="All 2 branches covered.">		    	if (check == 0) {</span>
<span class="fc" id="L220">			    	exists = false;</span>
			    }
<span class="pc bpc" id="L222" title="7 of 8 branches missed.">		    }</span>
		    
<span class="pc bpc" id="L224" title="7 of 8 branches missed.">		} catch (SQLException e) {</span>
<span class="nc" id="L225">		    throw new InvalidDBTransferException(&quot;SQL Exception occoured &quot; +</span>
		    		&quot;during executing nickTaken(Transaction trans, &quot; +
<span class="nc" id="L227">		    		&quot;String nickname)&quot;, e);</span>
		}
<span class="fc" id="L229">		return exists;</span>
    }

    /**
     * Uploads the passed image to the user data in the database.
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param userID
     *             the user ID which the image is assigned to
     * @param image
     *            the passed image
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * 
     * @author Patrick Cretu
     */
    public static void uploadImage(Transaction trans, int userID, Part image)
	    throws InvalidDBTransferException {
    	
<span class="fc" id="L250">		Connection connection = (Connection) trans;</span>
<span class="fc" id="L251">		java.sql.Connection conn = connection.getConn();</span>
<span class="fc" id="L252">		String query = &quot;UPDATE \&quot;users\&quot; SET profile_image = ? WHERE id = ?&quot;;</span>
		
<span class="fc" id="L254">		try (PreparedStatement stmt = conn.prepareStatement(query)) {</span>
<span class="fc" id="L255">		    InputStream inputStream = image.getInputStream();    </span>
<span class="fc" id="L256">		    stmt.setBinaryStream(1, inputStream, image.getSize());</span>
<span class="fc" id="L257">		    stmt.setInt(2, userID);</span>
	
<span class="fc" id="L259">		    stmt.executeUpdate();</span>
<span class="pc bpc" id="L260" title="7 of 8 branches missed.">		} catch (SQLException e) {</span>
<span class="nc" id="L261">		    throw new InvalidDBTransferException(&quot;SQL Exception occoured &quot; +</span>
		    		&quot;during executing uploadImage(Transaction trans, &quot; +
<span class="nc" id="L263">		    		&quot;int userID, Part image)&quot;, e);</span>
<span class="nc" id="L264">		} catch (IOException e) {</span>
<span class="nc" id="L265">		    throw new InvalidDBTransferException(&quot;SQL Exception occoured &quot; +</span>
		    		&quot;during executing uploadImage(Transaction trans, &quot; +
		    		&quot;int userID, Part image)&quot;);
		}
<span class="fc" id="L269">    }</span>

    /**
     * Adds a new user to the list of users in the database.
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param user
     *            the user to be added
     * @param pwHash
     *            the hashed password
     * @return the created id of the user
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * 
     * @author Katharina H�lzl
     */
    public static String createUser(Transaction trans, User user,
	    String pwHash, String salt) throws InvalidDBTransferException {

<span class="fc" id="L290">	String veriString = &quot;&quot;;</span>

	// Prepare SQL- INSERT and database connection.
<span class="fc" id="L293">	PreparedStatement pS = null;</span>
<span class="fc" id="L294">	Connection connection = (Connection) trans;</span>
<span class="fc" id="L295">	java.sql.Connection conn = connection.getConn();</span>

	// catch potential SQL-Injection
	try {
<span class="fc" id="L299">	    ResultSet res = null;</span>

<span class="fc" id="L301">	    String sql = &quot;SELECT id &quot;</span>
	               + &quot;FROM \&quot;users\&quot; &quot;
	               + &quot;WHERE veri_string = ?&quot;;
	    
	    // Create a new veristring which is not in the database yet.
	    do {
<span class="fc" id="L307">		SecureRandom random = new SecureRandom();</span>
<span class="fc" id="L308">		veriString = new BigInteger(130, random).toString();</span>
<span class="fc" id="L309">		pS = conn.prepareStatement(sql);</span>
<span class="fc" id="L310">		pS.setString(1, veriString);</span>
<span class="fc" id="L311">		res = pS.executeQuery();</span>
<span class="pc bpc" id="L312" title="1 of 2 branches missed.">	    } while (res.next());</span>

<span class="fc" id="L314">	    sql = &quot;Insert into \&quot;users\&quot; (first_name, name, nickname, email, &quot;</span>
	                                + &quot;pw_hash, date_of_birth, &quot;
	                                + &quot;form_of_address, credit_balance, &quot;
	                                + &quot;email_verification, &quot;
	                                + &quot;admin_verification, role, status, &quot;
	                                + &quot;veri_string, pw_salt) &quot;
		    + &quot;values (?, ?, ?, ?, ?, ?, ?::form_of_address, ?, ?, ?, &quot;
		                        + &quot;?::role, ?::status, ?, ?)&quot;;

	    // Filling PreparedStatement, check in optional fields if the user
	    // has inserted the data or if the value null must be written into
	    // the database.
<span class="fc" id="L326">	    pS = conn.prepareStatement(sql);</span>
<span class="pc bpc" id="L327" title="2 of 4 branches missed.">	    if (user.getFirstname() == null || user.getFirstname().length() &lt; 1) {</span>
<span class="nc" id="L328">		pS.setString(1, null);</span>
<span class="nc" id="L329">	    } else {</span>
<span class="fc" id="L330">		pS.setString(1, user.getFirstname());</span>
	    }
<span class="pc bpc" id="L332" title="2 of 4 branches missed.">	    if (user.getLastname() == null || user.getLastname().length() &lt; 1) {</span>
<span class="nc" id="L333">		pS.setString(2, null);</span>
<span class="nc" id="L334">	    } else {</span>
<span class="fc" id="L335">		pS.setString(2, user.getLastname());</span>
	    }
<span class="fc" id="L337">	    pS.setString(3, user.getUsername());</span>
<span class="fc" id="L338">	    pS.setString(4, user.getEmail());</span>
<span class="fc" id="L339">	    pS.setString(5, pwHash);</span>
<span class="pc bpc" id="L340" title="1 of 2 branches missed.">	    if (user.getDateOfBirth() == null) {</span>
<span class="nc" id="L341">		pS.setDate(6, null);</span>
<span class="nc" id="L342">	    } else {</span>
<span class="fc" id="L343">		java.sql.Date sqlDate = new java.sql.Date(user.getDateOfBirth()</span>
<span class="fc" id="L344">			.getTime());</span>
<span class="fc" id="L345">		pS.setDate(6, sqlDate);</span>
	    }
<span class="pc bpc" id="L347" title="1 of 2 branches missed.">	    if (user.getSalutation() == null) {</span>
<span class="nc" id="L348">		pS.setString(7, null);</span>
<span class="nc" id="L349">	    } else {</span>
<span class="fc" id="L350">		pS.setString(7, user.getSalutation().toString().toUpperCase());</span>
	    }
<span class="fc" id="L352">	    pS.setDouble(8, user.getAccountBalance());</span>
<span class="fc" id="L353">	    pS.setBoolean(9, false);</span>
<span class="fc bfc" id="L354" title="All 2 branches covered.">	    if(SystemDAO.getActivationType(trans) == Activation.EMAIL) {</span>
<span class="fc" id="L355">	        pS.setBoolean(10, true);	        </span>
<span class="fc" id="L356">	    } else {</span>
<span class="fc" id="L357">	        pS.setBoolean(10, false);</span>
	    }
<span class="fc" id="L359">	    pS.setString(11, user.getUserRole().toString());</span>
<span class="fc" id="L360">	    pS.setString(12, UserStatus.NOT_ACTIVATED.toString());</span>
<span class="fc" id="L361">	    pS.setString(13, veriString);</span>
<span class="fc" id="L362">	    pS.setString(14, salt);</span>
<span class="fc" id="L363">	    pS.executeUpdate();</span>

<span class="fc" id="L365">	    sql = &quot;Insert into \&quot;user_addresses\&quot; (user_id, country, &quot;</span>
	                                        + &quot;city, zip_code, street, &quot;
	                                        + &quot;house_nr) &quot;
		    + &quot;values (?, ?, ?, ?, ?, ?)&quot;;
<span class="fc" id="L369">	    pS = conn.prepareStatement(sql);</span>
<span class="fc" id="L370">	    pS.setInt(1, UserDAO.getUserID(trans, user.getUsername()));</span>
<span class="fc" id="L371">	    pS.setString(2, user.getAddress().getCountry());</span>
<span class="fc" id="L372">	    pS.setString(3, user.getAddress().getCity());</span>
<span class="fc" id="L373">	    pS.setInt(4, user.getAddress().getZipCode());</span>
<span class="pc bpc" id="L374" title="1 of 2 branches missed.">	    if(user.getAddress().getStreet() == null) {</span>
<span class="nc" id="L375">	        pS.setString(5, null);</span>
<span class="nc" id="L376">	    } else {</span>
<span class="fc" id="L377">	        pS.setString(5, user.getAddress().getStreet());</span>
	    }
<span class="pc bpc" id="L379" title="1 of 2 branches missed.">	    if(user.getAddress().getHouseNumber() == null) {</span>
<span class="nc" id="L380">	        pS.setNull(6, java.sql.Types.INTEGER);</span>
<span class="nc" id="L381">	    } else {</span>
<span class="fc" id="L382">	        pS.setInt(6, user.getAddress().getHouseNumber());</span>
	    }

<span class="fc" id="L385">	    pS.executeUpdate();</span>

<span class="fc" id="L387">	    pS.close();</span>
<span class="pc" id="L388">	} catch (SQLException e) {</span>
<span class="nc" id="L389">	    throw new InvalidDBTransferException(</span>
<span class="nc" id="L390">	                                &quot;Error occured during createUser&quot;, e);</span>
	}

<span class="fc" id="L393">	return veriString;</span>
    }

    /**
     * 
     * Returns a list containing all users stored in the database.
     * @author Sebastian
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param pagination
     *            the Pagination object which contains the amount of elements
     *            which are to be retrieved
     * @param searchString
     *            the input String which should be searched
     * @param searchParam
     *            the paramter which says in which coloum we should look
     * @return the list of users, or null if no users were retrieved
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     */
    public static ArrayList&lt;User&gt; getUsers(Transaction trans,
	    PaginationData pagination, String searchParam, String searchString)
	    throws InvalidDBTransferException {

<span class="fc" id="L418">        Connection connection = (Connection) trans;</span>
<span class="fc" id="L419">        java.sql.Connection conn = connection.getConn();</span>

<span class="fc" id="L421">        int limit = pagination.getElementsPerPage();</span>
<span class="fc" id="L422">        int offset = limit * pagination.getCurrentPageNumber();</span>
<span class="fc" id="L423">        String dir = pagination.getSortDirection().toString();</span>
<span class="fc" id="L424">        String query = null;</span>

<span class="pc bpc" id="L426" title="8 of 10 branches missed.">        switch (searchParam) {</span>
        case &quot;name&quot;:
<span class="nc" id="L428">            query = GET_USERS_BY_NAME;</span>
<span class="nc" id="L429">            break;</span>

    	case &quot;email&quot;:
<span class="nc" id="L432">    	    query = GET_USER_BY_EMAIL;</span>
<span class="nc" id="L433">    	    break;</span>
    
    	case &quot;nickname&quot;:
<span class="fc" id="L436">    	    query = GET_USER_BY_NICKNAME;</span>
<span class="fc" id="L437">    	    break;</span>
    
    	default:
<span class="nc" id="L440">    	    query = ALL_USERS;</span>
<span class="nc" id="L441">    	    return getAllUsers(conn, pagination,</span>
<span class="nc" id="L442">    		    String.format(query, pagination.getSortColumn(), dir), limit, offset);</span>
    
    	}
    
<span class="fc" id="L446">    	return getUsers(conn, pagination,</span>
<span class="fc" id="L447">    		String.format(query, pagination.getSortColumn(), dir), searchString, limit,</span>
<span class="fc" id="L448">    		offset);</span>
    }

    /**
     * Returns a List of All Users, depends how the pagination is defined and 
     * on which side we are
     * 
     * @author Sebastian
     * @param conn
     * @param pagination
     * @param query
     * @param limit
     * @param offset
     * @return a list of Users
     * @throws InvalidDBTransferException
     */
    private static ArrayList&lt;User&gt; getAllUsers(java.sql.Connection conn,
	    PaginationData pagination, String query, int limit, int offset)
	    throws InvalidDBTransferException {
	
<span class="nc" id="L468">        ArrayList&lt;User&gt; result = null;</span>
<span class="nc" id="L469">        try (PreparedStatement pS = conn.prepareStatement(query)) {</span>

<span class="nc" id="L471">            pS.setInt(1, limit);</span>
<span class="nc" id="L472">            pS.setInt(2, offset);</span>
<span class="nc" id="L473">            try(ResultSet resultSet = pS.executeQuery()){</span>
<span class="nc" id="L474">                result = getResult(resultSet);</span>
<span class="nc bnc" id="L475" title="All 8 branches missed.">            }    	</span>
<span class="nc bnc" id="L476" title="All 8 branches missed.">        } catch (SQLException e) {</span>
    	   
<span class="nc" id="L478">    	    throw new InvalidDBTransferException(&quot;Error occured during GetAllUsers Methode&quot;, e);</span>
    	}
<span class="nc" id="L480">    	return result;</span>
    }

    /**
     * Sets all Information about a User out of the ResultSet which was 
     * delivered
     * 
     * @author Sebastian
     * @param resultSet
     * @return
     * @throws SQLException
     */
    private static ArrayList&lt;User&gt; getResult(ResultSet resultSet)
	    throws SQLException {

<span class="fc" id="L495">        ArrayList&lt;User&gt; result = new ArrayList&lt;User&gt;();</span>

        try {

<span class="fc bfc" id="L499" title="All 2 branches covered.">    	    while (resultSet.next()) {</span>
<span class="fc" id="L500">    	        User userToAdd = new User();</span>
<span class="pc bpc" id="L501" title="1 of 2 branches missed.">    	        if (resultSet.getString(&quot;first_name&quot;) == null) {</span>
<span class="nc" id="L502">    	            userToAdd.setFirstname(&quot;Nicht angegeben&quot;);</span>
<span class="nc" id="L503">    	        } else {</span>
<span class="fc" id="L504">    	            userToAdd.setFirstname(resultSet.getString(&quot;first_name&quot;));</span>
    	        }
<span class="pc bpc" id="L506" title="1 of 2 branches missed.">    	        if (resultSet.getString(&quot;name&quot;) == null) {</span>
<span class="nc" id="L507">    	            userToAdd.setLastname(&quot;Nicht angegeben&quot;);</span>
<span class="nc" id="L508">    	        } else {</span>
<span class="fc" id="L509">    	            userToAdd.setLastname(resultSet.getString(&quot;name&quot;));</span>
    	        }
<span class="pc bpc" id="L511" title="1 of 2 branches missed.">    	        if (resultSet.getDate(&quot;date_of_birth&quot;) == null) {</span>
<span class="nc" id="L512">    	            SimpleDateFormat dateformat = new SimpleDateFormat(</span>
<span class="nc" id="L513">    	                    &quot;dd/MM/yyyy&quot;);</span>
<span class="nc" id="L514">    	            Date jesusBirth = dateformat.parse(&quot;25/12/0001&quot;);</span>
<span class="nc" id="L515">    	            userToAdd.setDateOfBirth(jesusBirth);</span>
<span class="nc" id="L516">    	        } else {</span>
<span class="fc" id="L517">    	            userToAdd.setDateOfBirth(new java.util.Date(resultSet</span>
<span class="fc" id="L518">    	                    .getDate(&quot;date_of_birth&quot;).getTime()));</span>
    	        }
<span class="fc" id="L520">    	        userToAdd.setEmail(resultSet.getString(&quot;email&quot;));</span>
    
<span class="fc" id="L522">    	        userToAdd.setUsername(resultSet.getString(&quot;nickname&quot;));</span>
<span class="fc" id="L523">    	        userToAdd.setUserID(resultSet.getInt(&quot;id&quot;));</span>
<span class="fc" id="L524">    	        result.add(userToAdd);</span>
    	    }

<span class="pc" id="L527">        } catch (SQLException e) {</span>
           
<span class="nc" id="L529">            throw new SQLException(&quot;Error occured during GetResult Methode&quot;);</span>
<span class="nc" id="L530">        } catch (ParseException e) {</span>
            //TODO dont know what to do
<span class="nc" id="L532">            LogHandler.getInstance().error(</span>
<span class="nc" id="L533">                    &quot;Error occured during Parsing Jesus Birthday&quot;);</span>
        }
	
<span class="fc" id="L536">        return result;</span>
    }



    /**
     * Returns a list of users which names contain the search term the user has
     * entered.
     * 
     * @author Sebastian
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param pagination
     *            the Pagination object which contains the amount of elements
     *            which are to be retrieved
     * @param searchString
     *            the user's search term
     * @param offset
     * @param limit
     * @return the list of users, or null if no users were retrieved
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * 
     */
    public static ArrayList&lt;User&gt; getUsers(java.sql.Connection conn,
	    PaginationData pagination, String query, String searchString,
	    int limit, int offset) throws InvalidDBTransferException {

<span class="fc" id="L565">        ArrayList&lt;User&gt; result = null;</span>

<span class="fc" id="L567">        try (PreparedStatement pS = conn.prepareStatement(query)) {</span>
<span class="fc" id="L568">            pS.setString(1, searchString);</span>
<span class="fc" id="L569">            pS.setInt(2, limit);</span>
<span class="fc" id="L570">            pS.setInt(3, offset);</span>
	    
<span class="fc" id="L572">            try(ResultSet resultSet = pS.executeQuery()){</span>
<span class="fc" id="L573">                result = getResult(resultSet);</span>
<span class="pc" id="L574">                return result;</span>
<span class="pc bpc" id="L575" title="7 of 8 branches missed.">            }    </span>
<span class="pc bpc" id="L576" title="7 of 8 branches missed.">        } catch (SQLException e) {</span>
	    
<span class="nc" id="L578">            throw new InvalidDBTransferException(&quot;Error occured during GetUsers(connection) Methode&quot;, e);</span>
        }

    }
    
    /**
     * Returns a user assigned to the specified ID.
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param userID
     *            the user's ID
     * @return the user assigned to the user ID, or null if no such user was
     *         found
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * 
     * @author Patrick Cretu
     */
    public static User getUser(Transaction trans, int userID)
	    throws InvalidDBTransferException {
    	
<span class="fc" id="L601">		Connection connection = (Connection) trans;</span>
<span class="fc" id="L602">		java.sql.Connection conn = connection.getConn();</span>
<span class="fc" id="L603">		User user = null;</span>
<span class="fc" id="L604">		String query = &quot;SELECT nickname FROM \&quot;users\&quot; WHERE id=?&quot;;</span>
	
<span class="fc" id="L606">		try (PreparedStatement stmt = conn.prepareStatement(query)) {</span>
<span class="fc" id="L607">		    stmt.setInt(1, userID);</span>
	
<span class="fc" id="L609">		    try (ResultSet rst = stmt.executeQuery()) {</span>
<span class="pc bpc" id="L610" title="1 of 2 branches missed.">		    	if (rst.next()) {</span>
<span class="fc" id="L611">		    		user = getUser(trans, rst.getString(1));</span>
			    }
<span class="pc bpc" id="L613" title="7 of 8 branches missed.">		    }</span>
		    
<span class="pc bpc" id="L615" title="7 of 8 branches missed.">		} catch (SQLException e) {</span>
<span class="nc" id="L616">		    throw new InvalidDBTransferException(&quot;SQL Exception occoured &quot; +</span>
		    		&quot;during executing getUser(Transaction trans, &quot; +
<span class="nc" id="L618">		    		&quot;int userID)&quot;, e);</span>
		}
<span class="fc" id="L620">		return user;</span>
    }

    /**
     * Returns the status of the user to a specified ID
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param userID
     *            the user's ID
     * @return the status of the user
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * 
     * @author Katharina H�lzl
     */
    public static UserStatus getUserStatus(Transaction trans, int userID)
	    throws InvalidDBTransferException {

<span class="fc" id="L640">	UserStatus userStatus = null;</span>

	// Prepare SQL- Request and database connection.
<span class="fc" id="L643">	Connection connection = (Connection) trans;</span>
<span class="fc" id="L644">	java.sql.Connection conn = connection.getConn();</span>

<span class="fc" id="L646">	String sql = &quot;SELECT status &quot;</span>
	           + &quot;FROM \&quot;users\&quot;&quot;
	           + &quot; WHERE id=?&quot;;
	
	// catch potential SQL-Injection
<span class="fc" id="L651">	try (PreparedStatement pS = conn.prepareStatement(sql)){</span>
<span class="fc" id="L652">	    pS.setInt(1, userID);</span>

	    // /execute preparedStatement, return resultSet as a list
	    // (here one entry in the list because the id is unique).
<span class="fc" id="L656">	    try(ResultSet res = pS.executeQuery()){</span>

	    // Execute next entry, return true if there is another entry,
	    // else false.
<span class="pc bpc" id="L660" title="1 of 2 branches missed.">	            if (res.next()) {</span>
<span class="fc" id="L661">        	       userStatus = UserStatus.fromString(</span>
<span class="fc" id="L662">        	                                   res.getString(&quot;status&quot;));</span>
<span class="fc" id="L663">        	    } else {</span>
<span class="nc" id="L664">        		userStatus = null;</span>
        	    }
        	    
<span class="pc bpc" id="L667" title="7 of 8 branches missed.">	    } catch (SQLException e) {</span>
<span class="nc" id="L668">	            throw new SQLException();</span>
	    }

<span class="pc bpc" id="L671" title="7 of 8 branches missed.">	} catch (SQLException e) {</span>
<span class="nc" id="L672">	    throw new InvalidDBTransferException(</span>
<span class="nc" id="L673">	                            &quot;Error occured during getUserStatus&quot;, e);</span>
	}
<span class="fc" id="L675">	return userStatus;</span>
    }

    /**
     * Returns the role of the user to a specified ID
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param userID
     *            the user's ID
     * @return the role of the user
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * 
     * @author Katharina H�lzl
     */
    public static UserRole getUserRole(Transaction trans, int userID)
	    throws InvalidDBTransferException {
<span class="fc" id="L694">	UserRole userRole = null;</span>

	// Prepare SQL- Request and database connection.
<span class="fc" id="L697">	Connection connection = (Connection) trans;</span>
<span class="fc" id="L698">	java.sql.Connection conn = connection.getConn();</span>

<span class="fc" id="L700">	String sql = &quot;SELECT role &quot;</span>
	           + &quot;FROM \&quot;users\&quot; &quot;
	           + &quot;WHERE id=?&quot;;
	
	// catch potential SQL-Injection
<span class="fc" id="L705">	try (PreparedStatement pS = conn.prepareStatement(sql)) {</span>
<span class="fc" id="L706">	    pS.setInt(1, userID);</span>

	    // execute preparedStatement, return resultSet as a list
	    // (here one entry in the list because the id is unique).
<span class="fc" id="L710">	    try(ResultSet res = pS.executeQuery()){</span>

        	    // Execute next entry, return true if there is another 
        	    // entry, else false.
<span class="pc bpc" id="L714" title="1 of 2 branches missed.">        	    if (res.next()) {</span>
<span class="fc" id="L715">        	        userRole =UserRole.fromString(res.getString(&quot;role&quot;));</span>
<span class="fc" id="L716">        	    } else {</span>
<span class="nc" id="L717">        		userRole = null;</span>
        	    }
<span class="pc bpc" id="L719" title="7 of 8 branches missed.">	    }catch (SQLException e) {</span>
<span class="nc" id="L720">                throw new SQLException();</span>
            }

<span class="pc bpc" id="L723" title="7 of 8 branches missed.">	} catch (SQLException e) {</span>
<span class="nc" id="L724">	    throw new InvalidDBTransferException(</span>
<span class="nc" id="L725">	                                &quot;Error occured during getUserRole&quot;, e);</span>
	}
<span class="fc" id="L727">	return userRole;</span>
    }

    /**
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param veriString
     * 
     * @return true if it succeed, else false
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * 
     * @author Katharina H�lzl
     */
    public static boolean verifyUser(Transaction trans, String veriString)
	    throws InvalidDBTransferException {
        
<span class="fc" id="L746">	boolean success = false;</span>

<span class="fc" id="L748">	Connection connection = (Connection) trans;</span>
<span class="fc" id="L749">	java.sql.Connection conn = connection.getConn();</span>

<span class="fc" id="L751">	String sql = &quot;UPDATE \&quot;users\&quot; &quot;</span>
	        + &quot;SET email_verification=?, &quot;
	                + &quot;veri_string=?, &quot;
	                + &quot;status=?::status &quot;
		+ &quot;WHERE veri_string=?&quot;;
	
	// catch potential SQL-Injection
<span class="fc" id="L758">	try (PreparedStatement pS = conn.prepareStatement(sql)){</span>
	    
<span class="fc" id="L760">	    pS.setBoolean(1, true);</span>
<span class="fc" id="L761">	    pS.setString(2, null);</span>
<span class="fc" id="L762">	    pS.setString(3, UserStatus.REGISTERED.toString());</span>
<span class="fc" id="L763">	    pS.setString(4, veriString);</span>

	    // Check if one row is affected by the update, then return true and 
	    // the user is activated, else false
<span class="pc bpc" id="L767" title="1 of 2 branches missed.">    	    if (pS.executeUpdate() == 1) {</span>
<span class="fc" id="L768">    		success = true;</span>
<span class="fc" id="L769">    	    } else {</span>
<span class="nc" id="L770">    		success = false;</span>
    	    }
	    
<span class="pc bpc" id="L773" title="7 of 8 branches missed.">	} catch (SQLException e) {</span>
<span class="nc" id="L774">	    throw new InvalidDBTransferException(</span>
<span class="nc" id="L775">	                                &quot;Error occured during verifyUser&quot;, e);</span>
	}

<span class="fc" id="L778">	return success;</span>
    }

    /**
     * Returns 0, if user name or password is wrong or the inserted user does not
     * exist in the database. Otherwise returns the id of the user.
     * 
     * 
     * @param trans
     *            transaction object
     * @param username
     *            the user name inserted by the user
     * @param passwordHash
     *            the password inserted by the user, which is hashed in the bean
     * @return the id of the user &lt;br&gt;
     *         or 0 if the user name or password is wrong
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * 
     * @author Katharina H�lzl
     */
    public static int proveLogin(Transaction trans, String username,
	    String passwordHash) throws InvalidDBTransferException {

<span class="fc" id="L802">	final int wrongUsernameOrPassword = -1;</span>
<span class="fc" id="L803">	final int accountNotActivated = -2;</span>

<span class="fc" id="L805">	int id = wrongUsernameOrPassword;</span>

	// Prepare SQL- Request and database connection.
<span class="fc" id="L808">	Connection connection = (Connection) trans;</span>
<span class="fc" id="L809">	java.sql.Connection conn = connection.getConn();</span>

<span class="fc" id="L811">	String sql = &quot;SELECT id, &quot;</span>
	                   + &quot;nickname, &quot;
	                   + &quot;pw_hash, &quot;
	                   + &quot;status, &quot;
	                   + &quot;email_verification,&quot;
	                   + &quot; admin_verification &quot;
	           + &quot;FROM \&quot;users\&quot; &quot;
	           + &quot; WHERE nickname=?&quot;;
	
	// catch potential SQL-Injection
<span class="fc" id="L821">	try (PreparedStatement pS = conn.prepareStatement(sql)){</span>
<span class="fc" id="L822">	    pS.setString(1, username);</span>

	    // execute preparedStatement, return resultSet as a list
	    // (here one entry in the list because the user name is unique)
<span class="fc" id="L826">	    try(ResultSet res = pS.executeQuery()){</span>
	        
        	    // execute next entry, return true if there is another 
        	    // entry, else false.
<span class="pc bpc" id="L830" title="1 of 2 branches missed.">        	    if (res.next()) {</span>
        		// Execute passwort from the Resultset.
<span class="fc" id="L832">        		String pwHashFromDB = res.getString(&quot;pw_hash&quot;);</span>
        
        		// Compare the saved password with the inserted one.
<span class="fc bfc" id="L835" title="All 2 branches covered.">        		if (passwordHash.equals(pwHashFromDB)) {</span>
        
<span class="fc" id="L837">        		    boolean emailVerification = res</span>
<span class="fc" id="L838">        			    .getBoolean(&quot;email_verification&quot;);</span>
<span class="fc" id="L839">        		    boolean adminVerification = res</span>
<span class="fc" id="L840">        			    .getBoolean(&quot;admin_verification&quot;);</span>
        
        		    // Check if the user is activated.
<span class="fc" id="L843">        		    if (res.getString(&quot;status&quot;).equals(</span>
<span class="pc bpc" id="L844" title="1 of 2 branches missed.">        			    UserStatus.REGISTERED.toString())) {</span>
<span class="pc bpc" id="L845" title="1 of 2 branches missed.">        			if (emailVerification == true) {</span>
<span class="fc" id="L846">        			    if (SystemDAO.getActivationType(trans).</span>
<span class="fc bfc" id="L847" title="All 2 branches covered.">        			            equals(Activation.EMAIL)) {</span>
<span class="fc" id="L848">        				id = res.getInt(&quot;id&quot;);</span>
<span class="fc" id="L849">        			    } else {</span>
<span class="fc bfc" id="L850" title="All 2 branches covered.">        				if (adminVerification == true) {</span>
<span class="fc" id="L851">        				    id = res.getInt(&quot;id&quot;);</span>
<span class="fc" id="L852">        				} else {</span>
<span class="fc" id="L853">        				    id = accountNotActivated;</span>
        				}
        			    }
<span class="fc" id="L856">        			} else {</span>
<span class="nc" id="L857">        			    id = accountNotActivated;</span>
        			}
<span class="nc" id="L859">        		    } else {</span>
<span class="nc" id="L860">        			id = accountNotActivated;</span>
        		    }
<span class="nc" id="L862">        		} else {</span>
<span class="fc" id="L863">        		    id = wrongUsernameOrPassword;</span>
        		}
<span class="fc" id="L865">        	    } else {</span>
<span class="nc" id="L866">        		id = wrongUsernameOrPassword;</span>
        	    }
	    
<span class="pc bpc" id="L869" title="7 of 8 branches missed.">	    } catch (SQLException e){</span>
<span class="nc" id="L870">	        throw new SQLException();</span>
	    }
<span class="pc bpc" id="L872" title="7 of 8 branches missed.">	} catch (SQLException e) {</span>
<span class="nc" id="L873">	    throw new InvalidDBTransferException(</span>
<span class="nc" id="L874">	                                &quot;Error occured during proveLogin&quot;, e);</span>

	}
<span class="fc" id="L877">	return id;</span>
    }

    /**
     * Returns all attributes of a user assigned to the passed user name.
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param username
     *            the user's name
     * @return the user
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * 
     * @author Katharina H�lzl
     */

    public static User getUser(Transaction trans, String username)
	    throws InvalidDBTransferException {

        // Generate a new user object and filling with the user name.
        // Generate a new address object.
<span class="fc" id="L900">        User user = new User();</span>
<span class="fc" id="L901">        user.setUsername(username);</span>
<span class="fc" id="L902">        Address address = new Address();</span>

        // Prepare SQL- Request and database connection.
<span class="fc" id="L905">        PreparedStatement pS = null;</span>
<span class="fc" id="L906">        Connection connection = (Connection) trans;</span>
<span class="fc" id="L907">        java.sql.Connection conn = connection.getConn();</span>

<span class="fc" id="L909">        String sql = &quot;SELECT * FROM \&quot;users\&quot; WHERE nickname=?&quot;;</span>

        // catch potential SQL-Injection
        try {
<span class="fc" id="L913">            pS = conn.prepareStatement(sql);</span>
<span class="fc" id="L914">            pS.setString(1, username);</span>

            // execute preparedStatement, return resultSet as a list
            // (here one entry in the list because the user name is unique)
<span class="fc" id="L918">            ResultSet res = pS.executeQuery();</span>
<span class="pc bpc" id="L919" title="1 of 2 branches missed.">            if (res.next()) {</span>

                // Fill the user object with values from the database.
<span class="fc" id="L922">                user.setUserId(res.getInt(&quot;id&quot;));</span>
<span class="fc" id="L923">                user.setFirstname(res.getString(&quot;first_name&quot;));</span>
<span class="fc" id="L924">                user.setLastname(res.getString(&quot;name&quot;));</span>
<span class="fc" id="L925">                user.setEmail(res.getString(&quot;email&quot;));</span>
                
<span class="pc bpc" id="L927" title="1 of 2 branches missed.">                if(res.getDate(&quot;date_of_birth&quot;) == null) {</span>
<span class="nc" id="L928">                    user.setDateOfBirth(null);</span>
<span class="nc" id="L929">                } else {</span>
<span class="fc" id="L930">                    user.setDateOfBirth(new java.util.Date(res.getDate(</span>
<span class="fc" id="L931">                        &quot;date_of_birth&quot;).getTime()));</span>
                }

<span class="fc" id="L934">                user.setSalutation(Salutation.fromString(</span>
<span class="fc" id="L935">                        res.getString(&quot;form_of_address&quot;)));</span>
<span class="fc" id="L936">                float accountBalance = res.getFloat(&quot;credit_balance&quot;);</span>
<span class="fc" id="L937">                user.setAccountBalance(accountBalance);</span>
<span class="fc" id="L938">                user.setUserRole(UserRole.fromString(</span>
<span class="fc" id="L939">                        res.getString(&quot;role&quot;)));</span>
<span class="fc" id="L940">                user.setUserStatus(UserStatus.fromString(</span>
<span class="fc" id="L941">                        res.getString(&quot;status&quot;)));</span>
                

<span class="fc" id="L944">                conn.commit();</span>

<span class="fc" id="L946">                sql = &quot;SELECT * FROM \&quot;user_addresses\&quot; WHERE user_id=?&quot;;</span>
<span class="fc" id="L947">                PreparedStatement pr = null;</span>
<span class="fc" id="L948">                pr = conn.prepareStatement(sql);</span>
<span class="fc" id="L949">                pr.setInt(1, user.getUserID());</span>

<span class="fc" id="L951">                ResultSet res2 = pr.executeQuery();</span>

<span class="pc bpc" id="L953" title="1 of 2 branches missed.">                if (res2.next()) {</span>
<span class="fc" id="L954">                    address.setId(res2.getInt(&quot;id&quot;));</span>
<span class="fc" id="L955">                    address.setCity(res2.getString(&quot;city&quot;));</span>
<span class="fc" id="L956">                    address.setCountry(res2.getString(&quot;country&quot;));</span>
<span class="fc" id="L957">                    address.setZipCode(res2.getInt(&quot;zip_code&quot;));</span>
<span class="fc" id="L958">                    address.setStreet(res2.getString(&quot;street&quot;));</span>
<span class="fc" id="L959">                    address.setHouseNumber(res2.getInt(&quot;house_nr&quot;));</span>
<span class="fc" id="L960">                } else {</span>
<span class="nc" id="L961">                    address = null;</span>
                }
                // Assign the address object to the user object.
<span class="fc" id="L964">                user.setAddress(address);</span>
<span class="fc" id="L965">                pr.close();</span>
<span class="fc" id="L966">                res2.close();</span>
<span class="fc" id="L967">            } else {</span>

<span class="nc" id="L969">                user = null;</span>
            }
<span class="fc" id="L971">            pS.close();</span>
<span class="fc" id="L972">            res.close();</span>
<span class="pc" id="L973">        } catch (SQLException e) {</span>
<span class="nc" id="L974">            LogHandler.getInstance().error(</span>
<span class="nc" id="L975">                    &quot;SQL Exception occoured during executing &quot;</span>
                            + &quot;getUser(Transaction trans, String username)&quot;);
<span class="nc" id="L977">            throw new InvalidDBTransferException();</span>
        }
        // Returns the filled user object.
<span class="fc" id="L980">        return user;</span>
    }

    /**
     * Returns the ID of a user assigned to the passed user name.
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param username
     *            the user's name
     * @return the user's ID
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * 
     * @author Katharina H�lzl
     */
    public static int getUserID(Transaction trans, String username)
	    throws InvalidDBTransferException {

<span class="fc" id="L1000">	final int userDoesNotExist = -1;</span>

<span class="fc" id="L1002">	int id = userDoesNotExist;</span>

<span class="fc" id="L1004">	Connection connection = (Connection) trans;</span>
<span class="fc" id="L1005">	java.sql.Connection conn = connection.getConn();</span>

<span class="fc" id="L1007">	String sql = &quot;SELECT id &quot;</span>
	           + &quot;FROM \&quot;users\&quot; &quot;
	           + &quot;WHERE nickname=?&quot;;

<span class="fc" id="L1011">	try (PreparedStatement pS = conn.prepareStatement(sql)){</span>
<span class="fc" id="L1012">	    pS.setString(1, username);</span>
	    
<span class="fc" id="L1014">	    try(ResultSet res = pS.executeQuery()){</span>
	        
	            // execute next entry, return true if there is another 
                    // entry, else false.
<span class="fc bfc" id="L1018" title="All 2 branches covered.">        	    if (res.next()) {</span>
<span class="fc" id="L1019">        		id = res.getInt(&quot;id&quot;);</span>
<span class="fc" id="L1020">        	    } else {</span>
        	        //Return -1 because there is no user with this nickname
<span class="fc" id="L1022">        		id = userDoesNotExist;</span>
        	    }
        	    
<span class="pc bpc" id="L1025" title="7 of 8 branches missed.">	    } catch (SQLException e) {</span>
<span class="nc" id="L1026">	            throw new SQLException();</span>
	    }

<span class="pc bpc" id="L1029" title="7 of 8 branches missed.">	} catch (SQLException e) {</span>
<span class="nc" id="L1030">	    throw new InvalidDBTransferException(</span>
<span class="nc" id="L1031">	                                &quot;Error occured during getUserID&quot;, e);</span>
	}

<span class="fc" id="L1034">	return id;</span>
    }

    /**
     * Updates a user stored in the database. The user's attributes are replaced
     * by the ones of the passed user.
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param user
     *            the user to be updated
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * @author Ricky Strohmeier
     */
    public static void updateUser(Transaction trans, User user, String pwHash, String salt)
	    throws InvalidDBTransferException {
<span class="fc" id="L1052">    	Connection connection = (Connection) trans;</span>
<span class="fc" id="L1053">    	java.sql.Connection conn = connection.getConn();</span>

<span class="fc" id="L1055">    	String emptyString = new String(&quot;null&quot;);</span>
<span class="fc" id="L1056">    	int emptyNumber = 0;</span>
    
<span class="fc" id="L1058">    	String updateQuery = &quot;UPDATE \&quot;users\&quot; &quot;</span>
    		+ &quot;SET first_name = ?, name = ?, nickname = ?, email = ?, &quot;
    		+ &quot;form_of_address = ?::form_of_address, date_of_birth = ?, &quot;
    		+ &quot;role = ?::role &quot;
    		+ &quot;WHERE id = ?;&quot;
    		+ &quot;UPDATE \&quot;user_addresses\&quot; &quot;
    		+ &quot;SET country = ?, city = ?, zip_code = ?, street = ?, house_nr = ? &quot;
    		+ &quot;WHERE user_id = ?&quot;;

<span class="pc bpc" id="L1067" title="3 of 4 branches missed.">    	if (pwHash != null &amp;&amp; salt != null){</span>
<span class="nc" id="L1068">    	    updateQuery = updateQuery + &quot;; UPDATE \&quot;users\&quot; &quot;</span>
<span class="nc" id="L1069">    	                              + &quot;SET pw_hash = ?, pw_salt = ? &quot;</span>
<span class="nc" id="L1070">    	                              + &quot;WHERE id = ?&quot;;</span>
    	}
    
<span class="fc" id="L1073">    	try(PreparedStatement statement = conn.prepareStatement(updateQuery)) {</span>
    	    //Update User Dates
<span class="fc" id="L1075">	        statement.setString(1, user.getFirstname());</span>
<span class="fc" id="L1076">    	    statement.setString(2, user.getLastname());</span>
<span class="fc" id="L1077">    	    statement.setString(3, user.getUsername());</span>
<span class="fc" id="L1078">    	    statement.setString(4, user.getEmail());</span>
<span class="fc" id="L1079">    	    statement.setString(5, user.getSalutation().toString().toUpperCase());</span>

    	    java.sql.Date birthday;
<span class="pc bpc" id="L1082" title="1 of 2 branches missed.">    	    if(user.getDateOfBirth() != null) {</span>
<span class="fc" id="L1083">    	        birthday = new java.sql.Date(user.getDateOfBirth().getTime());    	        </span>
<span class="fc" id="L1084">    	        statement.setDate(6, birthday);    	    </span>
<span class="fc" id="L1085">    	    } else {</span>
<span class="nc" id="L1086">    	        birthday = new java.sql.Date(0);</span>
<span class="nc" id="L1087">    	        statement.setDate(6, birthday);</span>
    	    }

<span class="fc" id="L1090">    	    statement.setString(7, user.getUserRole().toString());</span>

<span class="fc" id="L1092">    	    statement.setInt(8, user.getUserID());</span>

    	    //Update Address
<span class="pc bpc" id="L1095" title="1 of 2 branches missed.">    	    if(user.getAddress().getCountry() != null) {</span>
<span class="fc" id="L1096">    	        statement.setString(9, user.getAddress().getCountry());    	        </span>
<span class="fc" id="L1097">    	    } else {</span>
<span class="nc" id="L1098">    	        statement.setString(9, emptyString);</span>
    	    }

<span class="pc bpc" id="L1101" title="1 of 2 branches missed.">    	    if(user.getAddress().getCity() != null) {</span>
<span class="fc" id="L1102">    	        statement.setString(10, user.getAddress().getCity());    	        </span>
<span class="fc" id="L1103">    	    } else {</span>
<span class="nc" id="L1104">    	        statement.setString(10, emptyString);</span>
    	    }

<span class="pc bpc" id="L1107" title="1 of 2 branches missed.">    	    if(user.getAddress().getZipCode() != null) {</span>
<span class="fc" id="L1108">    	        statement.setInt(11, user.getAddress().getZipCode());    	        </span>
<span class="fc" id="L1109">    	    } else {</span>
<span class="nc" id="L1110">    	        statement.setInt(11, emptyNumber);</span>
    	    }

<span class="pc bpc" id="L1113" title="1 of 2 branches missed.">    	    if(user.getAddress().getStreet() != null) {</span>
<span class="fc" id="L1114">    	        statement.setString(12, user.getAddress().getStreet());    	        </span>
<span class="fc" id="L1115">    	    } else {</span>
<span class="nc" id="L1116">    	        statement.setString(12, emptyString);</span>
    	    }

<span class="pc bpc" id="L1119" title="1 of 2 branches missed.">    	    if(user.getAddress().getHouseNumber() != null) {</span>
<span class="fc" id="L1120">    	        statement.setInt(13, user.getAddress().getHouseNumber());</span>
<span class="fc" id="L1121">    	    } else {</span>
<span class="nc" id="L1122">    	        statement.setInt(13, emptyNumber);</span>
    	    }

<span class="fc" id="L1125">    	    statement.setInt(14, user.getUserID());</span>

<span class="pc bpc" id="L1127" title="3 of 4 branches missed.">    	    if (pwHash != null &amp;&amp; salt != null){</span>
<span class="nc" id="L1128">    	        statement.setString(15, pwHash);</span>
<span class="nc" id="L1129">    	        statement.setString(16, salt);</span>
<span class="nc" id="L1130">    	        statement.setInt(17, user.getUserID());</span>
    	    }

<span class="fc" id="L1133">    	    statement.executeUpdate();</span>
<span class="pc bpc" id="L1134" title="7 of 8 branches missed.">    	} catch (SQLException e) {</span>
<span class="nc" id="L1135">    	    LogHandler.getInstance().error(&quot;SQL Exception occoured in updateUser from UserDAO&quot;);</span>
<span class="nc" id="L1136">    	    throw new InvalidDBTransferException();</span>
    	}
<span class="fc" id="L1138">    }</span>

	/**
     * Updates the e-mail verification and user status, if the user decides to
     * change his e-mail address.
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param veriString
     * 
     * @return true if it succeed, else false
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * 
     * @author Patrick Cretu
     */
    public static void setVerification(Transaction trans, String veriString, int userID)
	    throws InvalidDBTransferException {
<span class="fc" id="L1157">		Connection connection = (Connection) trans;</span>
<span class="fc" id="L1158">		java.sql.Connection conn = connection.getConn();</span>
<span class="fc" id="L1159">		String query = &quot;UPDATE \&quot;users\&quot; SET email_verification = false, &quot; +</span>
				&quot;veri_string = ?, &quot; +
				&quot;status = ?::status WHERE id = ?&quot;;
		
<span class="fc" id="L1163">		try (PreparedStatement stmt = conn.prepareStatement(query)){</span>
		    
<span class="fc" id="L1165">			stmt.setString(1, veriString);</span>
<span class="fc" id="L1166">		    stmt.setString(2, UserStatus.NOT_ACTIVATED.toString());</span>
<span class="fc" id="L1167">		    stmt.setInt(3, userID);</span>
		    
<span class="fc" id="L1169">		    stmt.executeUpdate();</span>
<span class="pc bpc" id="L1170" title="7 of 8 branches missed.">		} catch (SQLException e) {</span>
<span class="nc" id="L1171">		    throw new InvalidDBTransferException(</span>
<span class="nc" id="L1172">		                                &quot;Error occured during verifyUser&quot;, e);</span>
		}
<span class="fc" id="L1174">    }</span>
    
    /**
     * Returns a verification string which is not already stored in the
     * database.
     * 
     * @param trans
     *            the transaction object which contains the database connection
     * @return a unique verification string
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     *             
     * @author Patrick Cretu
     */
    public static String checkVeriString (Transaction trans)
    		throws InvalidDBTransferException {
    	
<span class="fc" id="L1191">    	Connection connection = (Connection) trans;</span>
<span class="fc" id="L1192">		java.sql.Connection conn = connection.getConn();</span>
<span class="fc" id="L1193">		String veriString = &quot;&quot;;</span>
<span class="fc" id="L1194">		ResultSet rst = null;</span>
<span class="fc" id="L1195">    	String query = &quot;SELECT id FROM \&quot;users\&quot; WHERE veri_string = ?&quot;;</span>
    	
<span class="fc" id="L1197">    	try (PreparedStatement stmt = conn.prepareStatement(query)) {</span>
    		
    	    do {
<span class="fc" id="L1200">	    		SecureRandom random = new SecureRandom();</span>
<span class="fc" id="L1201">	    		veriString = new BigInteger(130, random).toString();</span>
<span class="fc" id="L1202">	    		stmt.setString(1, veriString);</span>
<span class="fc" id="L1203">	    		rst = stmt.executeQuery();</span>
<span class="pc bpc" id="L1204" title="1 of 2 branches missed.">    	    } while (rst.next());</span>
    	    
<span class="pc bpc" id="L1206" title="7 of 8 branches missed.">    	} catch (SQLException e) {</span>
<span class="nc" id="L1207">    		throw new InvalidDBTransferException(&quot;Error occured during &quot; +</span>
<span class="nc" id="L1208">    				&quot;checkVeriString (java.sql.Connection conn)&quot;, e);</span>
<span class="nc" id="L1209">		} finally {</span>
<span class="pc bpc" id="L1210" title="3 of 4 branches missed.">			if (rst != null) {</span>
				try {
<span class="pc" id="L1212">					rst.close();</span>
<span class="pc" id="L1213">				} catch (SQLException e) {</span>
<span class="nc" id="L1214">					throw new InvalidDBTransferException(&quot;Error occured during &quot; +</span>
		    				&quot;closing ResultSet in &quot; +
<span class="nc" id="L1216">		    				&quot;checkVeriString (java.sql.Connection conn)&quot;, e);</span>
				}
			}
<span class="nc" id="L1219">		}</span>
<span class="fc" id="L1220">		return veriString;</span>
    }

    /**
     * Overrides a user's password.
     * 
     * @param trans
     *            the transaction object which contains the database connection
     * @param mail
     *            the mail address of the user to be updated
     * @throws InvalidDBTransferException
     * @author Ricky Strohmeier
     */
    public static void overridePassword(Transaction trans, String mail,
	    String password) throws InvalidDBTransferException {
<span class="fc" id="L1235">    	PreparedStatement statement = null;</span>
<span class="fc" id="L1236">    	Connection connection = (Connection) trans;</span>
<span class="fc" id="L1237">    	java.sql.Connection conn = connection.getConn();</span>
    
<span class="fc" id="L1239">    	String sql = &quot;UPDATE \&quot;users\&quot; &quot; + &quot;SET pw_hash = ? &quot;</span>
    		+ &quot;WHERE email = ?&quot;;
    
    	try {
<span class="fc" id="L1243">    	    statement = conn.prepareStatement(sql);</span>
<span class="fc" id="L1244">    	    statement.setString(1, password);</span>
<span class="fc" id="L1245">    	    statement.setString(2, mail);</span>
<span class="fc" id="L1246">    	    statement.executeUpdate();</span>
<span class="fc" id="L1247">    	    statement.close();</span>
<span class="pc" id="L1248">    	} catch (SQLException e) {</span>
    	    LogHandler
<span class="nc" id="L1250">    		    .getInstance()</span>
<span class="nc" id="L1251">    		    .error(&quot;SQL Exception occoured during executing overridePassword(Transaction trans, String mail, String password&quot;);</span>
<span class="nc" id="L1252">    	    throw new InvalidDBTransferException();</span>
    	}
<span class="fc" id="L1254">    }</span>

    /**
     * Deletes either a user or a user image which is assigned to the passed ID.
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param userID
     *            the ID of the user to be deleted
     * @param deleteUser
     *                 value if either the user or the user image is deleted
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * 
     * @author Patrick Cretu
     */
    public static void delete(Transaction trans, int userID, boolean deleteUser)
	    throws InvalidDBTransferException {
    	
<span class="fc" id="L1274">		Connection connection = (Connection) trans;</span>
<span class="fc" id="L1275">		java.sql.Connection conn = connection.getConn();</span>
<span class="fc" id="L1276">		String query = null;</span>
<span class="fc" id="L1277">		String deleteUserQuery = &quot;DELETE FROM \&quot;users\&quot; WHERE id = ?&quot;;</span>
<span class="fc" id="L1278">		String deleteImageQuery = &quot;UPDATE \&quot;users\&quot; SET profile_image = NULL &quot; +</span>
				&quot;WHERE id = ?&quot;;
		
<span class="pc bpc" id="L1281" title="1 of 2 branches missed.">		if (deleteUser) {</span>
<span class="fc" id="L1282">			query = deleteUserQuery;</span>
<span class="fc" id="L1283">		} else {</span>
<span class="nc" id="L1284">			query = deleteImageQuery;</span>
		}
		
<span class="fc" id="L1287">		try (PreparedStatement stmt = conn.prepareStatement(query)) {</span>
<span class="fc" id="L1288">			stmt.setInt(1, userID);</span>
<span class="fc" id="L1289">		    stmt.executeUpdate();</span>
<span class="pc bpc" id="L1290" title="7 of 8 branches missed.">		} catch (SQLException e) {</span>
<span class="nc" id="L1291">		    throw new InvalidDBTransferException(&quot;SQL Exception occoured &quot; +</span>
		    		&quot;during executing uploadImage(Transaction trans, &quot; +
		    		&quot;int userID, Part image)&quot;);
		}
<span class="fc" id="L1295">    }</span>

    /**
     * Returns a list of courses of which the user assigned to the passed ID is
     * leader of.
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param userID
     *            the course leader's ID
     * @param pagination
     *            the Pagination object which contains the amount of elements
     *            which are to be retrieved
     * @return the list of courses which the user is leader of, or null if the
     *         user isn't leader of any course
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * @author Ricky Strohmeier
     */
    public static List&lt;Course&gt; getCoursesLeadedBy(Transaction trans, int userID, PaginationData pagination)
	    throws InvalidDBTransferException {

<span class="fc" id="L1318">        Connection connection = (Connection) trans;</span>
<span class="fc" id="L1319">        java.sql.Connection conn = connection.getConn();</span>
<span class="fc" id="L1320">        PreparedStatement statement = null;</span>
<span class="fc" id="L1321">        ResultSet resultSet = null;</span>
<span class="fc" id="L1322">        ArrayList&lt;Course&gt; courses = new ArrayList&lt;Course&gt;();</span>

<span class="fc" id="L1324">        int offset = pagination.getElementsPerPage() * pagination.getCurrentPageNumber();</span>
    
<span class="fc" id="L1326">        String courseQuery = &quot;SELECT * FROM \&quot;courses\&quot; WHERE courses.id IN &quot;</span>
            + &quot;(SELECT course_id FROM \&quot;course_instructors\&quot; where course_instructor_id = ?) &quot;
            + &quot; ORDER BY %s %s LIMIT ? OFFSET ?&quot;;
    
    
<span class="fc" id="L1331">        courseQuery = String.format(courseQuery, pagination.getSortColumn().toString(),</span>
<span class="fc" id="L1332">                                                        pagination.getSortDirection().toString());</span>
    
        try {
<span class="fc" id="L1335">            statement = conn.prepareStatement(courseQuery);</span>
<span class="fc" id="L1336">            statement.setInt(1, userID);</span>
<span class="fc" id="L1337">            statement.setInt(2, pagination.getElementsPerPage());</span>
<span class="fc" id="L1338">            statement.setInt(3, offset);</span>
<span class="fc" id="L1339">            resultSet = statement.executeQuery();</span>
    
<span class="fc bfc" id="L1341" title="All 2 branches covered.">            while (resultSet.next()) {</span>
<span class="fc" id="L1342">            Course course = CourseDAO.getCourse(trans, resultSet.getInt(&quot;id&quot;));</span>
<span class="fc" id="L1343">            courses.add(course);</span>
            }
<span class="fc" id="L1345">            statement.close();</span>
<span class="fc" id="L1346">            resultSet.close();</span>
<span class="pc" id="L1347">        } catch (SQLException e) {</span>
<span class="nc" id="L1348">            LogHandler.getInstance().error(&quot;Error occoured in getCoursesLeadedBy from UserDAO&quot;);</span>
<span class="nc" id="L1349">            throw new InvalidDBTransferException();</span>
        }
<span class="fc" id="L1351">        return courses;</span>
    }

    /**
     * Fetches the number of courses leaded by a course leader.
     * @param trans the transaction
     * @param userID the leader's id
     * @return the number of courses
     * @throws InvalidDBTransferException
     * @author Ricky Strohmeier
     */
    public static int getNumberOfCoursesLeadedBy(Transaction trans, int userID) throws InvalidDBTransferException {

<span class="fc" id="L1364">        int numberOfCourses = 0;</span>
<span class="fc" id="L1365">        String courseQuery = &quot;SELECT COUNT(*) FROM \&quot;course_instructors\&quot; WHERE course_instructor_id = ?&quot;;</span>
    
<span class="fc" id="L1367">        Connection connection = (Connection) trans;</span>
<span class="fc" id="L1368">        java.sql.Connection conn = connection.getConn();</span>
    
        PreparedStatement statement;

        try {
<span class="fc" id="L1373">            statement = conn.prepareStatement(courseQuery);</span>
<span class="fc" id="L1374">            statement.setInt(1, userID);</span>
<span class="fc" id="L1375">            ResultSet resultSet = statement.executeQuery();</span>
<span class="fc" id="L1376">            resultSet.next();</span>
<span class="fc" id="L1377">            numberOfCourses = resultSet.getInt(1);</span>
<span class="pc" id="L1378">        } catch (SQLException e) {</span>
<span class="nc" id="L1379">            LogHandler.getInstance().error(&quot;Error occoured during fetching the number of courses of a certain user.&quot;);</span>
<span class="nc" id="L1380">            throw new InvalidDBTransferException();</span>
        }
<span class="fc" id="L1382">        return numberOfCourses;</span>
    }

    /**
     * Returns a list of participants of the the selected course.
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param pagination
     *            the Pagination object which contains the amount of elements
     *            which are to be retrieved
     * @param courseID
     *            the id of the course from which you want to show the
     *            participants
     * @return list of participants
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * @author Katharina H�lzl
     */
    public static List&lt;User&gt; getParticipantsOfCourse(Transaction trans,
	    PaginationData pagination, int courseID)
	    throws InvalidDBTransferException {

<span class="fc" id="L1406">	List&lt;User&gt; userList = new ArrayList&lt;User&gt;();</span>

	// prepare SQL- request and database connection.
<span class="fc" id="L1409">	Connection connection = (Connection) trans;</span>
<span class="fc" id="L1410">	java.sql.Connection conn = connection.getConn();</span>

<span class="fc" id="L1412">	String sql = &quot;SELECT DISTINCT &quot;</span>
	                                + &quot;u.id, &quot;
	                                + &quot;u.nickname, &quot;
	                                + &quot;u.email, &quot;
	                                + &quot;u.profile_image, &quot;
		+ &quot;(SELECT EXISTS(SELECT * FROM inform_users &quot;
		               + &quot;WHERE user_id = cP.participant_id &quot;
		               + &quot;AND course_id = cP.course_id)) &quot;
		     + &quot;AS courseNews &quot;
		     + &quot;FROM course_participants cP, &quot;
		               + &quot;users u, &quot;
		               + &quot;inform_users iU &quot;
		+ &quot;WHERE cP.course_id = ? AND u.id = cP.participant_id &quot;
		+ &quot;ORDER BY %s %s LIMIT ? OFFSET ?;&quot;;

<span class="fc" id="L1427">	sql = String.format(sql, pagination.getSortColumn().toString(),</span>
<span class="fc" id="L1428">		pagination.getSortDirection().toString());</span>

<span class="fc" id="L1430">	try (PreparedStatement pS = conn.prepareStatement(sql)) {</span>
<span class="fc" id="L1431">	    pS.setInt(1, courseID);</span>
<span class="fc" id="L1432">	    pS.setInt(2, pagination.getElementsPerPage());</span>
<span class="fc" id="L1433">	    pS.setInt(</span>
<span class="fc" id="L1434">		    3,</span>
<span class="fc" id="L1435">		    pagination.getCurrentPageNumber()</span>
<span class="fc" id="L1436">			    * pagination.getElementsPerPage());</span>

<span class="fc" id="L1438">	    try(ResultSet res = pS.executeQuery()){</span>
<span class="pc bpc" id="L1439" title="1 of 2 branches missed.">        	    while (res.next()) {</span>
<span class="nc" id="L1440">        		User user = new User();</span>
<span class="nc" id="L1441">        		user.setUserId(res.getInt(&quot;id&quot;));</span>
<span class="nc" id="L1442">        		user.setEmail(res.getString(&quot;email&quot;));</span>
<span class="nc" id="L1443">        		user.setUsername(res.getString(&quot;nickname&quot;));</span>
<span class="nc" id="L1444">        		user.setCourseNewsSubscribed(</span>
<span class="nc" id="L1445">        		                         res.getBoolean(&quot;courseNews&quot;));</span>
<span class="nc" id="L1446">        		user.setProfilImage(res.getBytes(&quot;profile_image&quot;));</span>
<span class="nc" id="L1447">        		userList.add(user);</span>
        	    }
<span class="pc bpc" id="L1449" title="7 of 8 branches missed.">	    }catch (SQLException e) {</span>
<span class="nc" id="L1450">	            throw new SQLException();</span>
	    }
	    
<span class="pc bpc" id="L1453" title="7 of 8 branches missed.">	} catch (SQLException e) {</span>
<span class="nc" id="L1454">            throw new InvalidDBTransferException(</span>
<span class="nc" id="L1455">                            &quot;Error occured during getParticipantsOfCourse&quot;, e);</span>
	}

<span class="fc" id="L1458">	return userList;</span>
    }

    /**
     * Delete the selected participants from the course.
     * 
     * @param trans
     *          the Transaction object which contains the connection to the
     *          database
     * @param courseID
     *          the id of the course from which the users must be deleted
     * @param usersToRemove
     *          list of users which must be deleted
     * @return true if deleting was successful, else false
     * @author Katharina H�lzl
     */
    public static boolean removeParticipantsFromCourse(Transaction trans,
	    int courseID, List&lt;User&gt; usersToRemove) {
        
<span class="nc" id="L1477">	boolean success = false;</span>
	
<span class="nc bnc" id="L1479" title="All 4 branches missed.">	if (usersToRemove != null &amp;&amp; usersToRemove.size() &gt; 0) {</span>
	    
	    // prepare SQL- request and database connection.
<span class="nc" id="L1482">	    Connection connection = (Connection) trans;</span>
<span class="nc" id="L1483">	    java.sql.Connection conn = connection.getConn();</span>

<span class="nc" id="L1485">	    String sql = &quot;DELETE FROM course_participants &quot;</span>
	                + &quot;WHERE course_id = ? &quot;
	                + &quot;AND participant_id IN (?&quot;;
	    
	    // Add an '?' for each selected user to remove
<span class="nc bnc" id="L1490" title="All 2 branches missed.">	    for (int i = 1; i &lt; usersToRemove.size(); i++) {</span>
<span class="nc" id="L1491">		sql += &quot;,?&quot;;</span>
	    }
<span class="nc" id="L1493">	    sql += &quot;);&quot;;</span>

<span class="nc" id="L1495">	    try (PreparedStatement pS = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L1496">		pS.setInt(1, courseID);</span>
<span class="nc" id="L1497">		int counter = 2;</span>
		
		// Sets the '?' in the prepared statement
<span class="nc bnc" id="L1500" title="All 2 branches missed.">		for (User user : usersToRemove) {</span>
<span class="nc" id="L1501">		    pS.setInt(counter, user.getUserID());</span>
<span class="nc" id="L1502">		    counter++;</span>
		}
		
<span class="nc bnc" id="L1505" title="All 2 branches missed.">		if (pS.executeUpdate() &gt; 0) {</span>
<span class="nc" id="L1506">		    success = true;</span>
<span class="nc" id="L1507">		} else {</span>
<span class="nc" id="L1508">		    success = false;</span>
		}

<span class="nc bnc" id="L1511" title="All 8 branches missed.">	    } catch (SQLException e) {</span>
<span class="nc" id="L1512">	        throw new InvalidDBTransferException(</span>
<span class="nc" id="L1513">	                &quot;Error occured during removeParticipantsFromCourse&quot;, e);</span>
	    }
	} else {
<span class="nc" id="L1516">	    success = true;</span>
	}
<span class="nc" id="L1518">	return success;</span>
    }

    /**
     * 
     * Returns the number of participants of the course. This method is used 
     * for pagination to get the number of needed sites.
     * 
     * @param trans
     *          the Transaction object which contains the connection to the
     *          database
     * @param courseID
     *          the id of the course from which the participants should be 
     *          displayed
     * @return the number of participants of the course
     * @author Katharina H�lzl
     */
    public static int getNumberOfParticipants(Transaction trans, int courseID) {

<span class="nc" id="L1537">	int numberOfParticipants = 0;</span>

	// Prepare SQL- request and database connection.
<span class="nc" id="L1540">	Connection connection = (Connection) trans;</span>
<span class="nc" id="L1541">	java.sql.Connection conn = connection.getConn();</span>

<span class="nc" id="L1543">	String sql = &quot;SELECT COUNT (*) as courseParticipantNumber &quot;</span>
	            + &quot;FROM &quot;
	                    + &quot;(SELECT DISTINCT * &quot;
	                            + &quot;FROM &quot;
	                                + &quot;course_participants cP, &quot;
	                                + &quot;users u &quot;
	                            + &quot;WHERE cP.course_id = ? &quot;
	                            + &quot;AND u.id = cP.participant_id) &quot;
	            + &quot;AS courseParticipants;&quot;;

<span class="nc" id="L1553">	try (PreparedStatement pS = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L1554">	    pS.setInt(1, courseID);</span>
	    
<span class="nc" id="L1556">	    try(ResultSet res = pS.executeQuery()){</span>
<span class="nc" id="L1557">	        res.next();</span>
<span class="nc" id="L1558">	        numberOfParticipants = res.getInt(&quot;courseParticipantNumber&quot;);</span>
<span class="nc bnc" id="L1559" title="All 8 branches missed.">	    } catch (SQLException e) {</span>
<span class="nc" id="L1560">	            throw new SQLException();</span>
	        }

<span class="nc bnc" id="L1563" title="All 8 branches missed.">	} catch (SQLException e) {</span>
<span class="nc" id="L1564">            throw new InvalidDBTransferException(</span>
<span class="nc" id="L1565">                            &quot;Error occured during getNumberOfParticipants&quot;, e);</span>
	}

<span class="nc" id="L1568">	return numberOfParticipants;</span>
    }

    public static List&lt;User&gt; getParticipiantsOfCourseUnit(Transaction trans,
	    PaginationData pagination, int courseUnitId)
	    throws InvalidDBTransferException {
<span class="nc" id="L1574">	return null;</span>
    }

    /**
     * Returns whether the User wants to get Course News or not. Checks the inform_user
     * if the Relation UserID CourseID is included
     * 
     * @author Sebastian
     * @param trans
     * @param userID
     * @param courseID
     * @return  true or false
     * @throws InvalidDBTransferException
     */
    public static boolean userWantsToBeInformed(Transaction trans, int userID,
	    int courseID) throws InvalidDBTransferException {
	
<span class="fc" id="L1591">        Connection connection = (Connection) trans;</span>
<span class="fc" id="L1592">        java.sql.Connection conn = connection.getConn();</span>
<span class="fc" id="L1593">        String searchUserInUserToInform = &quot;SELECT * FROM \&quot;inform_users\&quot; WHERE user_id=? AND course_id=?&quot;;</span>

        try {
	    
<span class="fc" id="L1597">            boolean returnStatment = isInTable(userID, courseID, conn,</span>
<span class="fc" id="L1598">                    searchUserInUserToInform);</span>
            
            //TODO Remove here
<span class="fc" id="L1601">            LogHandler.getInstance().debug(</span>
<span class="fc" id="L1602">                    &quot;UserWantsToBeInformed methode was succesfull&quot;);</span>
<span class="fc" id="L1603">            return returnStatment;</span>

<span class="nc" id="L1605">        } catch (SQLException e) {</span>
<span class="nc" id="L1606">            throw new InvalidDBTransferException(&quot;Error occured during UserWantsToBeInformed methode &quot;, e);</span>
        }
    }

    /**
     * An extraceted Methode because this or similar SQL Commands are often used
     * 
     * @author Sebastian
     * @param userID
     * @param courseID
     * @param conn
     * @param searchUserInUserToInform
     * @return
     * @throws SQLException
     */
    private static boolean isInTable(int userID, int courseID,
	    java.sql.Connection conn, String searchUserInUserToInform)
	    throws SQLException {
	
<span class="fc" id="L1625">        try(PreparedStatement pS = conn.prepareStatement(searchUserInUserToInform)){</span>
<span class="fc" id="L1626">            pS.setInt(1, userID);</span>
<span class="fc" id="L1627">            pS.setInt(2, courseID);</span>
            
<span class="fc" id="L1629">            try(ResultSet resultSet = pS.executeQuery()){</span>
<span class="fc" id="L1630">                boolean returnStatment = resultSet.next();</span>
<span class="pc" id="L1631">                return returnStatment;</span>
<span class="pc bpc" id="L1632" title="7 of 8 branches missed.">            }</span>
<span class="pc bpc" id="L1633" title="7 of 8 branches missed.">        }</span>
    }

    /**
     * Checks whether the User is already Participant in that Course or Not
     * 
     * @author Sebastian
     * @param trans
     * @param userID
     * @param courseID
     * @return true or false
     * @throws InvalidDBTransferException
     */
    public static boolean userIsParticpant(Transaction trans, int userID,
	    int courseID) throws InvalidDBTransferException {
	
<span class="fc" id="L1649">        Connection connection = (Connection) trans;</span>
<span class="fc" id="L1650">        java.sql.Connection conn = connection.getConn();</span>
<span class="fc" id="L1651">        String searchUserCourse = &quot;SELECT * FROM \&quot;course_participants\&quot; WHERE participant_id=? AND course_id=?&quot;;</span>

        try {
<span class="fc" id="L1654">            boolean returnStatement = isInTable(userID, courseID, conn,</span>
<span class="fc" id="L1655">                    searchUserCourse);</span>
	    
            //TODO REMOVE
<span class="fc" id="L1658">            LogHandler.getInstance().debug(</span>
<span class="fc" id="L1659">		    &quot;UserIsParticipant methode was succesfull&quot;);</span>
<span class="fc" id="L1660">            return returnStatement;</span>
<span class="nc" id="L1661">        } catch (SQLException e) {</span>
	    
<span class="nc" id="L1663">	    throw new InvalidDBTransferException(&quot;Error occured during UserIsParticipant methode &quot;, e);</span>
        }
    }

    /**
     * Update the Users Account Balance after he signed up or signed off for a CourseUnit 
     * 
     * @author Sebastian Schwarz
     * @param trans
     * @param userID
     * @param newAccountBalance
     */
    public static void updateAccountBalance(Transaction trans, int userID,
	    float newAccountBalance) {
	
<span class="fc" id="L1678">        Connection connection = (Connection) trans;</span>
<span class="fc" id="L1679">        java.sql.Connection conn = connection.getConn();</span>
<span class="fc" id="L1680">        String updateAccountBalance = &quot;UPDATE \&quot;users\&quot; SET credit_balance = ? WHERE id = ?&quot;;</span>

<span class="fc" id="L1682">        try (PreparedStatement pS = conn.prepareStatement(updateAccountBalance)){</span>

<span class="fc" id="L1684">            pS.setFloat(1, newAccountBalance);</span>
<span class="fc" id="L1685">            pS.setInt(2, userID);</span>
<span class="fc" id="L1686">            pS.executeUpdate();</span>

            //TODO Remove
<span class="fc" id="L1689">            LogHandler.getInstance().debug(</span>
<span class="fc" id="L1690">                    &quot;AccountBalance succesfully update of User:&quot; + userID);</span>
<span class="pc bpc" id="L1691" title="7 of 8 branches missed.">        } catch (SQLException e) {</span>
           
<span class="nc" id="L1693">            throw new InvalidDBTransferException(&quot;Error acurred while updating Account Balance of User:&quot;</span>
<span class="nc" id="L1694">                    + userID, e);</span>
        }
<span class="fc" id="L1696">    }</span>

    /**
     * Checks whether the User is already Participant in the CourseUnit or not
     * 
     * @author Sebastian Schwarz
     * @param trans
     * @param userID
     * @param courseUnitID
     * @return true or false
     */
    public static boolean userIsParticipantInCourseUnit(Transaction trans,
	    int userID, int courseUnitID) throws InvalidDBTransferException {
	
<span class="fc" id="L1710">        Connection connection = (Connection) trans;</span>
<span class="fc" id="L1711">        java.sql.Connection conn = connection.getConn();</span>
<span class="fc" id="L1712">        String searchUserCourse = &quot;SELECT * FROM \&quot;course_unit_participants\&quot; WHERE participant_id=? AND course_unit_id=?&quot;;</span>

        try {
<span class="fc" id="L1715">            boolean returnStatement = isInTable(userID, courseUnitID, conn,</span>
<span class="fc" id="L1716">                    searchUserCourse);</span>
	    
            //TODO Remove
<span class="fc" id="L1719">            LogHandler.getInstance().debug(</span>
<span class="fc" id="L1720">		    &quot;UserIsParticipantInCourseUnit methode was succesfull&quot;);</span>
<span class="fc" id="L1721">            return returnStatement;</span>
<span class="nc" id="L1722">        } catch (SQLException e) {</span>

<span class="nc" id="L1724">	    throw new InvalidDBTransferException(&quot;Error occured during UserIsParticipantInCourseUnit methode &quot;, e);</span>
        }
    }

    /**
     * Returns the UserImage as byte Array From the Database
    
     * @author Sebastian Schwarz
     * @param trans
     * @param courseID
     * @return ProfilImage
     */
    public static byte[] getImage(Transaction trans, int userID)
	    throws InvalidDBTransferException {
	
<span class="fc" id="L1739">        Connection connection = (Connection) trans;</span>
<span class="fc" id="L1740">        java.sql.Connection conn = connection.getConn();</span>
        byte[] picture;
<span class="fc" id="L1742">        String selectImage = &quot;SELECT profile_image FROM \&quot;users\&quot; WHERE id=?&quot;;</span>

<span class="fc" id="L1744">        try (PreparedStatement pS = conn.prepareStatement(selectImage)){</span>
	    
<span class="fc" id="L1746">            pS.setInt(1, userID);</span>
<span class="fc" id="L1747">            try(ResultSet resultSet = pS.executeQuery()){</span>
                
<span class="pc bpc" id="L1749" title="1 of 2 branches missed.">                if (resultSet.next()) {</span>
                    
<span class="fc" id="L1751">                    picture = resultSet.getBytes(&quot;profile_image&quot;);                   </span>
<span class="fc" id="L1752">                    return picture;</span>
                } else {
                    
                    //Returns null, so that the HTTP Servlet knows that he has to load the dummy Picture
<span class="nc" id="L1756">                    return null;</span>
                }
<span class="pc bpc" id="L1758" title="9 of 10 branches missed.">            }</span>

<span class="pc bpc" id="L1760" title="9 of 10 branches missed.">        } catch (SQLException e) {</span>

<span class="nc" id="L1762">	    throw new InvalidDBTransferException(&quot;Exception occured during loading User Picture from Database&quot;, e);</span>
        }
    }

    /**
     * Identifys the UserNickname on the Database by his EMail Address and returns 
     * the User
     * 
     * @author Sebastian Schwarz
     * @param trans
     * @param email
     * @return searched User
     */
    public static User getUserPerMail(Transaction trans, String email) {
	
<span class="fc" id="L1777">        Connection connection = (Connection) trans;</span>
<span class="fc" id="L1778">        java.sql.Connection conn = connection.getConn();</span>
<span class="fc" id="L1779">        User user = null;</span>
<span class="fc" id="L1780">        String query = &quot;SELECT nickname FROM \&quot;users\&quot; WHERE email=?&quot;;</span>
         	
<span class="fc" id="L1782">        try(PreparedStatement stmt = conn.prepareStatement(query)) {</span>

<span class="fc" id="L1784">            stmt.setString(1, email);</span>
<span class="fc" id="L1785">            try(ResultSet rst = stmt.executeQuery()){</span>
                
<span class="pc bpc" id="L1787" title="1 of 2 branches missed.">                if (rst.next()) {</span>
                    //Uses the Already implemented getUser, no Code reproduction
<span class="fc" id="L1789">                    user = getUser(trans, rst.getString(1));</span>
                }
<span class="pc bpc" id="L1791" title="7 of 8 branches missed.">            }       </span>
<span class="pc bpc" id="L1792" title="7 of 8 branches missed.">        } catch (SQLException e) {</span>
	    
<span class="nc" id="L1794">            throw new InvalidDBTransferException(&quot;SQL Exception occoured during executing getUser(Transaction trans, email)&quot;, e);</span>
        }
<span class="fc" id="L1796">        return user;</span>
    }

    /**
     * Returns The Number of Users the systems has
     * 
     * @author Sebastian
     * @param transaction
     * @return Number of Users the System has as Integer
     */
    public static int getNumberOfUsers(Transaction transaction) {
	
<span class="nc" id="L1808">        Connection connection = (Connection) transaction;</span>
<span class="nc" id="L1809">        java.sql.Connection conn = connection.getConn();</span>
<span class="nc" id="L1810">        String sql = &quot;SELECT COUNT (*) FROM \&quot;users\&quot;&quot;;</span>

<span class="nc" id="L1812">        try (PreparedStatement pS = conn.prepareStatement(sql)) {	    </span>
<span class="nc" id="L1813">            try(ResultSet resultSet = pS.executeQuery()){</span>
	        
<span class="nc bnc" id="L1815" title="All 2 branches missed.">                if (resultSet.next()) {</span>
<span class="nc" id="L1816">                    return resultSet.getInt(1);</span>
                }	         
<span class="nc bnc" id="L1818" title="All 10 branches missed.">            }</span>
<span class="nc bnc" id="L1819" title="All 10 branches missed.">        } catch (SQLException e) {</span>
                
<span class="nc" id="L1821">            throw new InvalidDBTransferException(&quot;SQL Exception occoured during executing getNumberOfUsers&quot;, e);</span>
        }

<span class="nc" id="L1824">	return 0;</span>
    }

    /**
     * Returns the Number of Users which has this Name
     * 
     * @author Sebastian
     * @param transaction
     * @param searchParam
     * @return
     */
    public static int getNumberOfUsersWithThisName(Transaction transaction,
	    String searchParam) {
	
<span class="nc" id="L1838">        Connection connection = (Connection) transaction;</span>
<span class="nc" id="L1839">        java.sql.Connection conn = connection.getConn();</span>
<span class="nc" id="L1840">        String sql = &quot;SELECT COUNT (*) FROM \&quot;users\&quot; where name = ?&quot;;</span>

<span class="nc" id="L1842">        try (PreparedStatement pS = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L1843">            pS.setString(1, searchParam);</span>
<span class="nc" id="L1844">            try(ResultSet  resultSet = pS.executeQuery()){</span>
	        
<span class="nc bnc" id="L1846" title="All 2 branches missed.">                if (resultSet.next()) {</span>
<span class="nc" id="L1847">                    return resultSet.getInt(1);</span>
                }
<span class="nc bnc" id="L1849" title="All 10 branches missed.">            }</span>
<span class="nc bnc" id="L1850" title="All 10 branches missed.">        } catch (SQLException e) {</span>

<span class="nc" id="L1852">            throw new InvalidDBTransferException(&quot;SQL Exception occoured during executing getNumberOfUsersWithThisName&quot;, e);</span>
        }

<span class="nc" id="L1855">        return 0;</span>
    }

    /**
     * Return the number of users which are not yet activated by a 
     * administrator
     * 
     * @param trans
     *          the Transaction object which contains the connection to the
     *          database
     * @return the number of users which are not yet activated by a 
     *          administrator or course leader, return -1 if every user is yet 
     *          activated by a administrator
     * @throws InvalidDBTransferException
     *                          if any error occurred during the execution 
     *                          of the method
     * @author Katharina H�lzl
     */
    public static int getNumberOfNotAdminActivatedUsers(Transaction trans)
	    throws InvalidDBTransferException {
<span class="fc" id="L1875">	int numberOfNotAdminActivatedUsers = -1;</span>

<span class="fc" id="L1877">	Connection connection = (Connection) trans;</span>
<span class="fc" id="L1878">	java.sql.Connection conn = connection.getConn();</span>

<span class="fc" id="L1880">	String sql = &quot;SELECT COUNT (*) AS numberOfNotAdminActivatedUsers &quot;</span>
	            + &quot;FROM users &quot;
	            + &quot;WHERE admin_verification = ?&quot;;

<span class="fc" id="L1884">	try (PreparedStatement pS = conn.prepareStatement(sql)) {</span>
<span class="fc" id="L1885">	    pS.setBoolean(1, false);</span>

<span class="fc" id="L1887">	    try( ResultSet res = pS.executeQuery()){</span>
	        
<span class="pc bpc" id="L1889" title="1 of 2 branches missed.">        	    if (res.next()) {</span>
<span class="fc" id="L1890">        		numberOfNotAdminActivatedUsers = res.getInt(1);</span>
<span class="fc" id="L1891">        	    } else {</span>
<span class="nc" id="L1892">        		numberOfNotAdminActivatedUsers = -1;</span>
        	    }
        	    
<span class="pc bpc" id="L1895" title="7 of 8 branches missed.">	    } catch (SQLException e) {</span>
<span class="nc" id="L1896">                throw new SQLException();</span>
	    }
	    
<span class="pc bpc" id="L1899" title="7 of 8 branches missed.">	} catch (SQLException e) {</span>
<span class="nc" id="L1900">	    throw new InvalidDBTransferException(</span>
<span class="nc" id="L1901">	           &quot;Error occured during getNumberOfNotAdminActivatedUsers&quot;, e);</span>
	}
<span class="fc" id="L1903">	return numberOfNotAdminActivatedUsers;</span>
    }

    /**
     * Returns the list of the users which are not yet activated by a 
     * administrator or a course leader
     * 
     * @param trans
     *          the Transaction object which contains the connection to the
     *          database
     * @param pagination
     *          the Pagination object which contains the amount of elements
     *          which are to be retrieved
     * @return a list of the users which are not yet activated by a 
     *         administrator
     * @throws InvalidDBTransferException
     *                          if any error occurred during the execution of 
     *                          the method
     * @author Katharina H�lzl
     */
    public static List&lt;User&gt; getNotAdminActivatedUsers(Transaction trans,
	    PaginationData pagination) throws InvalidDBTransferException {
        
<span class="fc" id="L1926">	List&lt;User&gt; notAdminActivatedUsers = new ArrayList&lt;User&gt;();</span>

<span class="fc" id="L1928">	Connection connection = (Connection) trans;</span>
<span class="fc" id="L1929">	java.sql.Connection conn = connection.getConn();</span>

<span class="fc" id="L1931">	String sql = &quot;SELECT id, &quot;</span>
	                    + &quot;first_name, &quot;
	                    + &quot;name, &quot;
	                    + &quot;email, &quot;
	                    + &quot;nickname, &quot;
	                    + &quot;date_of_birth &quot;
	             + &quot;FROM users &quot;
	             + &quot;WHERE admin_verification = ? &quot;
	             + &quot;ORDER BY %s %s LIMIT ? OFFSET ?;&quot;;

<span class="fc" id="L1941">	sql = String.format(sql, pagination.getSortColumn().toString(),</span>
<span class="fc" id="L1942">		pagination.getSortDirection().toString());</span>

<span class="fc" id="L1944">	try (PreparedStatement pS = conn.prepareStatement(sql)) {</span>
<span class="fc" id="L1945">	    pS.setBoolean(1, false);</span>
<span class="fc" id="L1946">	    pS.setInt(2, pagination.getElementsPerPage());</span>
<span class="fc" id="L1947">	    pS.setInt(3, pagination.getCurrentPageNumber()</span>
<span class="fc" id="L1948">			    * pagination.getElementsPerPage());</span>

<span class="fc" id="L1950">	    try(ResultSet res = pS.executeQuery()){</span>

<span class="fc bfc" id="L1952" title="All 2 branches covered.">        	    while (res.next()) {</span>
<span class="fc" id="L1953">        		User user = new User();</span>
<span class="fc" id="L1954">        		user.setUserId(res.getInt(&quot;id&quot;));</span>
<span class="fc" id="L1955">        		user.setFirstname(res.getString(&quot;first_name&quot;));</span>
<span class="fc" id="L1956">        		user.setLastname(res.getString(&quot;name&quot;));</span>
<span class="fc" id="L1957">        		user.setEmail(res.getString(&quot;email&quot;));</span>
<span class="fc" id="L1958">        		user.setUsername(res.getString(&quot;nickname&quot;));</span>
        		
<span class="pc bpc" id="L1960" title="1 of 2 branches missed.">        		if(res.getDate(&quot;date_of_birth&quot;) == null) {</span>
<span class="nc" id="L1961">        		    user.setDateOfBirth(null);</span>
<span class="nc" id="L1962">        		} else {</span>
<span class="fc" id="L1963">        		    user.setDateOfBirth(new java.util.Date(res.getDate(</span>
<span class="fc" id="L1964">        			&quot;date_of_birth&quot;).getTime()));</span>
        		}
<span class="fc" id="L1966">        		notAdminActivatedUsers.add(user);</span>
        	    }
<span class="pc bpc" id="L1968" title="7 of 8 branches missed.">	    }catch (SQLException e) {</span>
<span class="nc" id="L1969">                throw new SQLException();</span>
            }
	    
<span class="pc bpc" id="L1972" title="7 of 8 branches missed.">	} catch (SQLException e) {</span>
<span class="nc" id="L1973">	    throw new InvalidDBTransferException(</span>
<span class="nc" id="L1974">	                &quot;Error occured during getNotAdminActivatedUsers&quot;, e);</span>
	}
<span class="fc" id="L1976">	return notAdminActivatedUsers;</span>
    }
    
    
    /**
     * Activates the selected users.
     * 
     * @param trans
     *          the Transaction object which contains the connection to the
     *          database
     * @param usersToActivate
     *                  list of the users which are selected to activate
     * @return true if the activation of the users was successful, else false
     * @throws InvalidDBTransferException
     *                          if any error occurred during the execution of 
     *                          the method
     * @author Katharina H�lzl
     */
    public static boolean AdminActivateUsers(Transaction trans,
            List&lt;User&gt; usersToActivate) throws InvalidDBTransferException {
        
<span class="fc" id="L1997">        boolean success = false;</span>
        
<span class="pc bpc" id="L1999" title="2 of 4 branches missed.">        if (usersToActivate != null &amp;&amp; usersToActivate.size() &gt; 0) {</span>
            
            // prepare SQL- request and database connection.
<span class="fc" id="L2002">            Connection connection = (Connection) trans;</span>
<span class="fc" id="L2003">            java.sql.Connection conn = connection.getConn();</span>

<span class="fc" id="L2005">            String sql = &quot;UPDATE users &quot;</span>
                    + &quot;SET admin_verification = ? &quot;
                    + &quot;WHERE id &quot;
                    + &quot;IN (?&quot;;
            
            // Add an '?' for each selected user to activate
<span class="pc bpc" id="L2011" title="1 of 2 branches missed.">            for (int i = 1; i &lt; usersToActivate.size(); i++) {</span>
<span class="nc" id="L2012">                sql += &quot;,?&quot;;</span>
            }
<span class="fc" id="L2014">            sql += &quot;);&quot;;</span>

<span class="fc" id="L2016">            try (PreparedStatement pS = conn.prepareStatement(sql)) {</span>
<span class="fc" id="L2017">                pS.setBoolean(1, true);</span>
<span class="fc" id="L2018">                int counter = 2;</span>
                
                // Sets the '?' in the prepared statement
<span class="fc bfc" id="L2021" title="All 2 branches covered.">                for (User user : usersToActivate) {</span>
<span class="fc" id="L2022">                    pS.setInt(counter, user.getUserID());</span>
<span class="fc" id="L2023">                    counter++;</span>
                }
                
<span class="fc bfc" id="L2026" title="All 2 branches covered.">                if (pS.executeUpdate() &gt; 0) {</span>
<span class="fc" id="L2027">                    success = true;</span>
<span class="fc" id="L2028">                } else {</span>
<span class="fc" id="L2029">                    success = false;</span>
                }

<span class="pc bpc" id="L2032" title="7 of 8 branches missed.">            } catch (SQLException e) {</span>
<span class="nc" id="L2033">                throw new InvalidDBTransferException(</span>
<span class="nc" id="L2034">                                &quot;Error occured during AdminActivateUsers&quot;, e);</span>
            }
            
        } else {
<span class="nc" id="L2038">            success = true;</span>
        }
        
<span class="fc" id="L2041">        return success;</span>
    }
    

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>