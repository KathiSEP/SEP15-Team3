<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>CourseDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">C:\Users\blacky\Documents\GitHub\SEP15-Team3\Code</a> &gt; <a href="index.source.html" class="el_package">de.ofCourse.databaseDAO</a> &gt; <span class="el_source">CourseDAO.java</span></div><h1>CourseDAO.java</h1><pre class="source lang-java linenums">/**
 * This package represents the Data Access Objects of the ofCourse system.
 */
package de.ofCourse.databaseDAO;

import java.io.IOException;
import java.io.InputStream;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import javax.servlet.http.Part;

import de.ofCourse.exception.InvalidDBTransferException;
import de.ofCourse.model.Address;
import de.ofCourse.model.Course;
import de.ofCourse.model.CourseUnit;
import de.ofCourse.model.PaginationData;
import de.ofCourse.model.User;
import de.ofCourse.model.UserRole;
import de.ofCourse.system.Connection;
import de.ofCourse.system.LogHandler;
import de.ofCourse.system.Transaction;

/**
 * Provides methods for transactions with the courses stored in the database
 * such as creating, retrieving, updating or deleting courses. Also adds or
 * removes users and course leaders to a course.
 * 
 * &lt;p&gt;
 * Each method has a Transaction parameter, which contains the SQL connection to
 * the database, in order to assure that multiple, consecutive method calls
 * within a certain method use the same connection.
 * &lt;/p&gt;
 * 
 * &lt;p&gt;
 * This class is required in the business logic of the system, more precisely in
 * the ManagedBeans of the package &lt;code&gt;de.ofCourse.action&lt;/code&gt;.
 * &lt;/p&gt;
 *
 */
<span class="nc" id="L48">public class CourseDAO {</span>

	/**
	 * @author Patrick Cretu
	 */
    private final static String NUM_COURSES_DAY = &quot;SELECT COUNT(DISTINCT &quot; +
    		&quot;\&quot;courses\&quot;.id) FROM \&quot;courses\&quot;, \&quot;course_units\&quot; &quot; +
    		&quot;WHERE \&quot;course_units\&quot;.start_time::date = current_date &quot; +
    		&quot;AND \&quot;course_units\&quot;.course_id = \&quot;courses\&quot;.id&quot;;

    /**
	 * @author Patrick Cretu
	 */
    private final static String NUM_COURSES_WEEK = &quot;SELECT COUNT(DISTINCT &quot; +
    		&quot;\&quot;courses\&quot;.id) FROM \&quot;courses\&quot;, \&quot;course_units\&quot; &quot; +
	    &quot;WHERE \&quot;course_units\&quot;.start_time::date between current_date &quot; +
	    &quot;AND current_date + integer '6'&quot;;

    /**
	 * @author Patrick Cretu
	 */
    private final static String NUM_COURSES_TOTAL = &quot;SELECT COUNT(DISTINCT &quot; +
    		&quot;\&quot;courses\&quot;.id) FROM \&quot;courses\&quot;&quot;;

    /**
	 * @author Patrick Cretu
	 */
    private final static String NUM_COURSES_ID = &quot;SELECT COUNT(DISTINCT &quot; +
    		&quot;\&quot;courses\&quot;.id) FROM \&quot;courses\&quot; WHERE CAST(id AS TEXT) LIKE ?&quot;;

    /**
	 * @author Patrick Cretu
	 */
    private final static String NUM_COURSES_TITLE = &quot;SELECT COUNT(DISTINCT &quot; +
    		&quot;\&quot;courses\&quot;.id) FROM \&quot;courses\&quot; WHERE LOWER(title) LIKE LOWER(?)&quot;;

    /**
	 * @author Patrick Cretu
	 */
    private final static String NUM_COURSES_LEADER = &quot;SELECT COUNT(DISTINCT &quot; +
    		&quot;\&quot;courses\&quot;.id) FROM \&quot;courses\&quot;, \&quot;users\&quot;, &quot; +
    		&quot;\&quot;course_instructors\&quot; &quot; +
    		&quot;WHERE LOWER(\&quot;users\&quot;.name) LIKE LOWER(?) &quot; +
    		&quot;AND \&quot;users\&quot;.id = \&quot;course_instructors\&quot;.course_instructor_id &quot; +
    		&quot;AND \&quot;course_instructors\&quot;.course_id = courses.id&quot;;

    /**
	 * @author Patrick Cretu
	 */
    private final static String NUM_COURSES_DATE = &quot;SELECT COUNT(DISTINCT &quot; +
    		&quot;\&quot;courses\&quot;.id) FROM \&quot;courses\&quot;, \&quot;course_units\&quot; &quot; +
    		&quot;WHERE \&quot;courses\&quot;.id = \&quot;course_units\&quot;.course_id &quot; +
    		&quot;AND \&quot;course_units\&quot;.start_time::date = ?&quot;;

    /**
	 * @author Patrick Cretu
	 */
    private final static String CURRENT_DATE_COURSES = &quot;SELECT DISTINCT &quot; +
    		&quot;courses.id, courses.title, courses.max_participants, &quot; +
    		&quot;courses.start_date, courses.end_date FROM \&quot;courses\&quot;, &quot; +
    		&quot;\&quot;course_units\&quot; &quot; +
    		&quot;WHERE \&quot;course_units\&quot;.start_time::date = current_date &quot; +
    		&quot;AND \&quot;course_units\&quot;.course_id = \&quot;courses\&quot;.id &quot; +
    		&quot;ORDER BY %s %s LIMIT ? OFFSET ?&quot;;

    /**
	 * @author Patrick Cretu
	 */
    private final static String CURRENT_WEEK_COURSES = &quot;SELECT DISTINCT &quot; +
    		&quot;courses.id, courses.title, courses.max_participants, &quot; +
    		&quot;courses.start_date, courses.end_date FROM \&quot;courses\&quot;, &quot; +
    		&quot;\&quot;course_units\&quot; &quot; +
    		&quot;WHERE \&quot;course_units\&quot;.start_time::date BETWEEN current_date &quot; +
    		&quot;AND current_date + integer '6' &quot; +
    		&quot;AND \&quot;course_units\&quot;.course_id = \&quot;courses\&quot;.id &quot; +
    		&quot;ORDER BY %s %s LIMIT ? OFFSET ?&quot;;

    /**
	 * @author Patrick Cretu
	 */
    private final static String ALL_COURSES = &quot;SELECT * FROM \&quot;courses\&quot; &quot; +
    		&quot;ORDER BY %s %s LIMIT ? OFFSET ?&quot;;

    /**
	 * @author Patrick Cretu
	 */
    private final static String GET_COURSES_BY_ID = &quot;SELECT * FROM &quot; +
    		&quot;\&quot;courses\&quot; WHERE CAST(id AS TEXT) LIKE ? &quot; +
    		&quot;ORDER BY %s %s LIMIT ? OFFSET ?&quot;;

    /**
	 * @author Patrick Cretu
	 */
    private final static String GET_COURSES_BY_TITLE = &quot;SELECT * FROM &quot; +
    		&quot;\&quot;courses\&quot; WHERE LOWER(title) LIKE LOWER(?) &quot; +
    		&quot;ORDER BY %s %s LIMIT ? OFFSET ?&quot;;

    /**
	 * @author Patrick Cretu
	 */
    private final static String GET_COURSES_BY_LEADER = &quot;SELECT courses.id, &quot; +
    		&quot;courses.title, courses.max_participants, courses.start_date,&quot; +
    		&quot;courses.end_date FROM \&quot;courses\&quot;, \&quot;users\&quot;, &quot; +
    		&quot;\&quot;course_instructors\&quot; &quot; +
    		&quot;WHERE LOWER(\&quot;users\&quot;.name) LIKE LOWER(?) &quot; +
    		&quot;AND \&quot;users\&quot;.id = \&quot;course_instructors\&quot;.course_instructor_id &quot; +
    		&quot;AND \&quot;course_instructors\&quot;.course_id = courses.id &quot; +
    		&quot;ORDER BY %s %s LIMIT ? OFFSET ?&quot;;

    /**
	 * @author Patrick Cretu
	 */
    private final static String GET_COURSES_BY_DATE = &quot;SELECT DISTINCT &quot; +
    		&quot;courses.id, courses.title, courses.max_participants, &quot; +
    		&quot;courses.start_date, courses.end_date &quot;+ 
    		&quot;FROM \&quot;courses\&quot;, \&quot;course_units\&quot; &quot;+ 
    		&quot;WHERE \&quot;courses\&quot;.id = \&quot;course_units\&quot;.course_id &quot; +
    		&quot;AND \&quot;course_units\&quot;.start_time::date = ? &quot; +
    		&quot;ORDER BY %s %s LIMIT ? OFFSET ?&quot;;
    
    /**
     * @author Tobias Fuchs
     */
    private final static String GET_MY_COURSES  = &quot;SELECT DISTINCT courses.id,&quot; 
	    + &quot; courses.title, (SELECT course_units.start_time &quot; 
            + &quot;FROM course_units WHERE courses.id = course_units.course_id &quot; 
	    + &quot;AND course_units.start_time &gt; CURRENT_TIMESTAMP &quot; 
	    + &quot;ORDER BY course_units.start_time LIMIT 1), &quot; 
	    + &quot;(SELECT course_unit_addresses.location FROM course_units, &quot; 
            + &quot;course_unit_addresses WHERE course_units.id = &quot; 
	    + &quot;course_unit_addresses.course_unit_id &quot;
	    + &quot;AND courses.id = course_units.course_id AND &quot; 
	    + &quot;course_units.start_time &gt; CURRENT_TIMESTAMP ORDER BY &quot; 
	    + &quot;course_units.start_time LIMIT 1) &quot; 
            + &quot;FROM courses WHERE courses.id IN (SELECT course_id FROM &quot; 
	    + &quot;course_participants WHERE participant_id = ?) &quot;
	    + &quot;ORDER BY %s %s LIMIT ? OFFSET ?&quot;;

    /**
     * @author Tobias Fuchs
     */
    private final static String COUNT_MY_COURSES =  &quot;SELECT COUNT(*) FROM&quot; 
	    + &quot; \&quot;courses\&quot; WHERE courses.id IN (SELECT course_id &quot; 
	    + &quot;FROM \&quot;course_participants\&quot; WHERE participant_id = ?)&quot;;
    
    /**
     * Deletes all the courses from the system where the end date is before 
     * the actual date
     * 
     * @param trans
     *          the Transaction object which contains the connection to the
     *          database
     * @return true if the maintenance was successful, else false
     * @throws InvalidDBTransferException
     *                          if any error occurred during the execution of 
     *                          the method
     * @author Katharina H�lzl
     */
    public static boolean doCourseMaintenance(Transaction trans)
	    throws InvalidDBTransferException {
<span class="fc" id="L208">	boolean success = false;</span>

<span class="fc" id="L210">	Connection connection = (Connection) trans;</span>
<span class="fc" id="L211">	java.sql.Connection conn = connection.getConn();</span>

<span class="fc" id="L213">	String sql = &quot;DELETE FROM courses &quot;</span>
	           + &quot;WHERE end_date &lt; CURRENT_TIMESTAMP&quot;;

	// catch potential SQL-Injection
<span class="fc" id="L217">	try (PreparedStatement pS = conn.prepareStatement(sql)) {</span>
<span class="fc" id="L218">	    pS.executeUpdate();</span>
<span class="pc bpc" id="L219" title="7 of 8 branches missed.">	} catch (SQLException e) {</span>
<span class="nc" id="L220">	    throw new InvalidDBTransferException(</span>
<span class="nc" id="L221">	                        &quot;Error occured during doCourseMaintenance&quot;, e);</span>

	}
<span class="fc" id="L224">	return success;</span>
    }

    /**
     * Checks, whether the inserted id of the course leader exists in the system
     * or not.
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param courseLeaderID
     *            ID of the course leader
     * @return true if the id of the course leader exists in the system, else
     *         false
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * 
     * @author Katharina H�lzl
     */
    public static boolean courseLeaderExists(Transaction trans,
	    int courseLeaderID) throws InvalidDBTransferException {

<span class="fc" id="L246">	boolean courseLeaderExists = false;</span>

	// Prepare SQL- INSERT and database connection
<span class="fc" id="L249">	Connection connection = (Connection) trans;</span>
<span class="fc" id="L250">	java.sql.Connection conn = connection.getConn();</span>

<span class="fc" id="L252">	String sql = &quot;SELECT * &quot;</span>
	           + &quot;FROM users &quot;
	           + &quot;WHERE id = ? AND role != ?::role&quot;;

	// catch potential SQL-Injection
<span class="fc" id="L257">	try (PreparedStatement pS = conn.prepareStatement(sql)){</span>

	    // Filling PreparedStatement.
<span class="fc" id="L260">	    pS.setInt(1, courseLeaderID);</span>
<span class="fc" id="L261">	    pS.setString(2, UserRole.REGISTERED_USER.toString());</span>

<span class="fc" id="L263">	    try(ResultSet res = pS.executeQuery()){</span>
<span class="fc" id="L264">	        courseLeaderExists = res.next();</span>

<span class="pc bpc" id="L266" title="7 of 8 branches missed.">	    }catch (SQLException e) {</span>
<span class="nc" id="L267">	            throw new SQLException();</span>
	        }
	    
<span class="pc bpc" id="L270" title="7 of 8 branches missed.">	} catch (SQLException e) {</span>
<span class="nc" id="L271">	    throw new InvalidDBTransferException(</span>
<span class="nc" id="L272">	                        &quot;Error occured during courseLeaderExists&quot;, e);</span>
	}
<span class="fc" id="L274">	return courseLeaderExists;</span>
    }

    /**
     * Adds a new course to the list of courses in the database.
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param course
     *            the course to be added
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * 
     * @author Katharina H�lzl
     */
    public static int createCourse(Transaction trans, Course course,
	    Part courseImage) throws InvalidDBTransferException {

<span class="fc" id="L293">	final int errorGeneratingCourse = -1;</span>

<span class="fc" id="L295">	int generatedCourseID = errorGeneratingCourse;</span>

	// Prepare SQL- INSERT and database connection.
<span class="fc" id="L298">	Connection connection = (Connection) trans;</span>
<span class="fc" id="L299">	java.sql.Connection conn = connection.getConn();</span>

<span class="fc" id="L301">	String sql = &quot;Insert into \&quot;courses\&quot; (title, max_participants, &quot;</span>
	                                    + &quot;start_date, end_date, &quot;
	                                    + &quot;description, image) &quot;
	           + &quot;values (?, ?, ?, ?, ?, ?) &quot;
	           + &quot;RETURNING id&quot;;

	// catch potential SQL-Injection
<span class="fc" id="L308">	try (PreparedStatement pS = conn.prepareStatement(sql)){</span>

	    // Filling PreparedStatement, check in optional fields if the user
	    // has inserted the data or if the value null must be written into
	    // the database.
<span class="pc bpc" id="L313" title="2 of 4 branches missed.">	    if (course.getTitle() == null || course.getTitle().length() &lt; 1) {</span>
<span class="nc" id="L314">		pS.setString(1, null);</span>
<span class="nc" id="L315">	    } else {</span>
<span class="fc" id="L316">		pS.setString(1, course.getTitle());</span>
	    }
	    
<span class="pc bpc" id="L319" title="1 of 2 branches missed.">	    if (course.getMaxUsers() == null) {</span>
<span class="nc" id="L320">		pS.setInt(2, 1);</span>
<span class="nc" id="L321">	    } else {</span>
<span class="fc" id="L322">		pS.setInt(2, course.getMaxUsers());</span>
	    }
	    
<span class="fc" id="L325">	    pS.setDate(3, new java.sql.Date(course.getStartdate().getTime()));</span>
<span class="fc" id="L326">	    pS.setDate(4, new java.sql.Date(course.getEnddate().getTime()));</span>
	    
<span class="pc bpc" id="L328" title="1 of 2 branches missed.">	    if (course.getDescription() == null</span>
<span class="pc bpc" id="L329" title="1 of 2 branches missed.">		    || course.getDescription().length() &lt; 1) {</span>
<span class="nc" id="L330">		pS.setString(5, null);</span>
<span class="nc" id="L331">	    } else {</span>
<span class="fc" id="L332">		pS.setString(5, course.getDescription());</span>
	    }
	    
<span class="pc bpc" id="L335" title="1 of 4 branches missed.">	    if (courseImage != null &amp;&amp; courseImage.getInputStream() != null) {</span>
<span class="fc" id="L336">		InputStream inputStream = courseImage.getInputStream();</span>
<span class="fc" id="L337">		pS.setBinaryStream(6, inputStream, courseImage.getSize());</span>
<span class="fc" id="L338">	    } else {</span>
<span class="fc" id="L339">		pS.setBinaryStream(6, null, 0);</span>
	    }
	    
<span class="fc" id="L342">	    try(ResultSet res = pS.executeQuery()){</span>
<span class="fc" id="L343">	        res.next();</span>
<span class="fc" id="L344">	        generatedCourseID = res.getInt(&quot;id&quot;);</span>
<span class="pc bpc" id="L345" title="7 of 8 branches missed.">	    } catch (SQLException e) {</span>
<span class="nc" id="L346">                throw new SQLException(&quot;Error occured during createCourse&quot;, e);</span>
            }
	    
<span class="pc bpc" id="L349" title="7 of 8 branches missed.">	} catch (SQLException e) {</span>
<span class="nc" id="L350">	    throw new InvalidDBTransferException(</span>
<span class="nc" id="L351">	                                &quot;Error occured during createCourse&quot;, e);</span>
<span class="nc" id="L352">	} catch (IOException e) {</span>
<span class="nc" id="L353">	    throw new InvalidDBTransferException();</span>
	}
<span class="fc" id="L355">	return generatedCourseID;</span>
    }

    /**
     * Counts the number of courses retrieved based on the search string.
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param param
     *            the parameter by which the user has searched
     * @param searchString
     *                   the entered user input
     * @return the number of courses of the result
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * 
     * @author Patrick Cretu
     */
    public static int getNumberOfCourses(Transaction trans, String param,
	    String searchString) throws InvalidDBTransferException {
    	
<span class="fc" id="L377">		Connection connection = (Connection) trans;</span>
<span class="fc" id="L378">		java.sql.Connection conn = connection.getConn();</span>
<span class="fc" id="L379">		String query = null;</span>
		
<span class="pc bpc" id="L381" title="18 of 22 branches missed.">		switch (param) {</span>
		case &quot;day&quot;:
<span class="nc" id="L383">		    query = NUM_COURSES_DAY;</span>
<span class="nc" id="L384">		    return countCourses(conn, query, null, false);</span>
		case &quot;week&quot;:
<span class="nc" id="L386">		    query = NUM_COURSES_WEEK;</span>
<span class="nc" id="L387">		    return countCourses(conn, query, null, false);</span>
		case &quot;total&quot;:
<span class="fc" id="L389">		    query = NUM_COURSES_TOTAL;</span>
<span class="fc" id="L390">		    return countCourses(conn, query, null, false);</span>
		case &quot;id&quot;:
<span class="nc" id="L392">		    query = NUM_COURSES_ID;</span>
<span class="nc" id="L393">		    return countCourses(conn, query, searchString, false);</span>
		case &quot;title&quot;:
<span class="fc" id="L395">		    query = NUM_COURSES_TITLE;</span>
<span class="fc" id="L396">		    return countCourses(conn, query, searchString, false);</span>
		case &quot;leader&quot;:
<span class="nc" id="L398">		    query = NUM_COURSES_LEADER;</span>
<span class="nc" id="L399">		    return countCourses(conn, query, searchString, false);</span>
		case &quot;start_date&quot;:
<span class="nc" id="L401">		    query = NUM_COURSES_DATE;</span>
<span class="nc" id="L402">		    return countCourses(conn, query, searchString, true);</span>
		}
<span class="nc" id="L404">		return 0;</span>
    }

    /**
     * Executes the count query.
     * 
     * @param conn
     *           the SQL connection for the database
     * @param query
     *            the SQL query
     * @param searchString
     *                   the user's search input
     * @return the number of resulting courses
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * 
     * @author Patrick Cretu
     */
    private static int countCourses(java.sql.Connection conn, String query,
	    String searchString, boolean isDate)
	    throws InvalidDBTransferException {
<span class="fc" id="L425">		int numCourses = 0;</span>
	
<span class="fc" id="L427">		try (PreparedStatement stmt = conn.prepareStatement(query)) {</span>
<span class="fc bfc" id="L428" title="All 2 branches covered.">		    if (searchString != null) {</span>
<span class="pc bpc" id="L429" title="1 of 2 branches missed.">			    if (isDate) {</span>
<span class="nc" id="L430">				    SimpleDateFormat format =</span>
<span class="nc" id="L431">				    		new SimpleDateFormat(&quot;dd.MM.yyyy&quot;);</span>
				    Date parsed;
				    try {
<span class="nc" id="L434">				    	parsed = format.parse(searchString);</span>
<span class="nc" id="L435">				    } catch (ParseException e) {</span>
<span class="nc" id="L436">				    	throw new InvalidDBTransferException(</span>
<span class="nc" id="L437">				    			&quot;SQL Exception occoured during &quot; +</span>
				    			&quot;countCourses(java.sql.Connection conn,&quot; +
				    			&quot;String query, String searchString, &quot; +
				    			&quot;boolean isDate)&quot;);
				    }
<span class="nc" id="L442">				    java.sql.Date date = new java.sql.Date(parsed.getTime());</span>
<span class="nc" id="L443">				    stmt.setDate(1, date);</span>
<span class="nc" id="L444">				} else {</span>
<span class="fc" id="L445">					String search = &quot;%&quot; + searchString + &quot;%&quot;;</span>
<span class="fc" id="L446">					stmt.setString(1, search);</span>
				}
		    }
	
<span class="fc" id="L450">		    try (ResultSet rst = stmt.executeQuery()) {</span>
<span class="fc" id="L451">		    	rst.next();</span>
<span class="fc" id="L452">		    	numCourses = rst.getInt(1);</span>
<span class="pc bpc" id="L453" title="7 of 8 branches missed.">		    }</span>
<span class="pc bpc" id="L454" title="7 of 8 branches missed.">		} catch (SQLException e) {</span>
<span class="nc" id="L455">		    throw new InvalidDBTransferException(&quot;SQL Exception occoured &quot; +</span>
		    		&quot;during countCourses(java.sql.Connection conn, &quot; +
<span class="nc" id="L457">		    		&quot;String query, String searchString)&quot;, e);</span>
		}
<span class="fc" id="L459">		return numCourses;</span>
    }

    /**
     * Returns the courses retrieved from the database based on the passed
     * period.
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param pagination
     *                 the object containing the pagination values
     * @param period
     *             the requested time period
     * @return the courses retrieved from the database
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * 
     * @author Patrick Cretu
     */
    public static List&lt;Course&gt; getCourses(Transaction trans,
	    PaginationData pagination, String period)
	    throws InvalidDBTransferException {
    	
<span class="fc" id="L483">		Connection connection = (Connection) trans;</span>
<span class="fc" id="L484">		java.sql.Connection conn = connection.getConn();</span>
<span class="fc" id="L485">		int limit = pagination.getElementsPerPage();</span>
<span class="fc" id="L486">		int offset = limit * pagination.getCurrentPageNumber();</span>
<span class="fc" id="L487">		String orderParam = pagination.getSortColumn().toString();</span>
<span class="fc" id="L488">		String dir = pagination.getSortDirection().toString();</span>
		String query;
	
<span class="pc bpc" id="L491" title="6 of 7 branches missed.">		switch (period) {</span>
		case &quot;day&quot;:
<span class="nc" id="L493">		    query = CURRENT_DATE_COURSES;</span>
<span class="nc" id="L494">		    break;</span>
		case &quot;week&quot;:
<span class="nc" id="L496">		    query = CURRENT_WEEK_COURSES;</span>
<span class="nc" id="L497">		    break;</span>
		default:
<span class="fc" id="L499">		    query = ALL_COURSES;</span>
		    break;
		}
<span class="fc" id="L502">		return getCoursesInPeriod(conn, limit, offset,</span>
<span class="fc" id="L503">			String.format(query, orderParam, dir));</span>
    }

    /**
     * Executes the SQL query and returns the resulting list of courses.
     * 
     * @param conn
     *           the SQL connection for the database
     * @param limit
     *            the number of courses to which the result is limited
     * @param offset
     *             the offset
     * @param query
     *            the SQL query
     * @return the resulting list of courses
     *  @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * 
     * @author Patrick Cretu
     */
    private static List&lt;Course&gt; getCoursesInPeriod(java.sql.Connection conn,
	    int limit, int offset, String query)
	    throws InvalidDBTransferException {
<span class="fc" id="L526">		List&lt;Course&gt; result = null;</span>
		
<span class="fc" id="L528">		try (PreparedStatement stmt = conn.prepareStatement(query)) {</span>
<span class="fc" id="L529">		    stmt.setInt(1, limit);</span>
<span class="fc" id="L530">		    stmt.setInt(2, offset);</span>
	
<span class="fc" id="L532">		    try (ResultSet rst = stmt.executeQuery()) {</span>
<span class="fc" id="L533">		    	result = getResult(rst);</span>
<span class="pc bpc" id="L534" title="7 of 8 branches missed.">		    }</span>
<span class="pc bpc" id="L535" title="7 of 8 branches missed.">		} catch (SQLException e) {</span>
<span class="nc" id="L536">		    throw new InvalidDBTransferException(&quot;SQL Exception occoured &quot; +</span>
		    		&quot;during getCoursesInPeriod(java.sql.Connection conn, &quot; +
		    		&quot;int limit, int offset, String orderParam, &quot; +
<span class="nc" id="L539">		    		&quot;String query)&quot;, e);</span>
		}
<span class="fc" id="L541">		return result;</span>
    }

    /**
     * Returns a list of courses which titles contain the search term the user
     * has entered.
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param pagination
     *            the Pagination object which contains the amount of elements
     *            which are to be retrieved
     * @param searchString
     *            the user's search term
     * @return the list of courses, or null if no courses were retrieved
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * 
     * @author Patrick Cretu
     */
    public static List&lt;Course&gt; getCourses(Transaction trans,
	    PaginationData pagination, String searchParam, String searchString)
	    throws InvalidDBTransferException {
    	
<span class="fc" id="L566">		Connection connection = (Connection) trans;</span>
<span class="fc" id="L567">		java.sql.Connection conn = connection.getConn();</span>
<span class="fc" id="L568">		int limit = pagination.getElementsPerPage();</span>
<span class="fc" id="L569">		int offset = limit * pagination.getCurrentPageNumber();</span>
<span class="fc" id="L570">		String orderParam =</span>
<span class="fc" id="L571">				pagination.getSortColumn().getSortColumn().toString();</span>
<span class="fc" id="L572">		String dir = pagination.getSortDirection().toString();</span>
<span class="fc" id="L573">		String query = null;</span>
<span class="fc" id="L574">		boolean isDate = false;</span>
	
<span class="pc bpc" id="L576" title="8 of 10 branches missed.">		switch (searchParam) {</span>
		case &quot;title&quot;:
<span class="fc" id="L578">		    query = GET_COURSES_BY_TITLE;</span>
<span class="fc" id="L579">		    break;</span>
		case &quot;leader&quot;:
<span class="nc" id="L581">		    query = GET_COURSES_BY_LEADER;</span>
<span class="nc" id="L582">		    break;</span>
		case &quot;start_date&quot;:
<span class="nc" id="L584">		    query = GET_COURSES_BY_DATE;</span>
<span class="nc" id="L585">		    isDate = true;</span>
<span class="nc" id="L586">		    break;</span>
		default:
<span class="nc" id="L588">		    query = GET_COURSES_BY_ID;</span>
		}
<span class="fc" id="L590">		return getCourses(conn, limit, offset, searchString,</span>
<span class="fc" id="L591">			String.format(query, orderParam, dir), isDate);</span>
    }
    
    
    /**
     * Executes the SQL query and returns the resulting list of courses.
     * 
     * @param conn
     *           the SQL connection for the database
     * @param limit
     *            the number of courses to which the result is limited
     * @param offset
     *             the offset
     * @param searchString
     *                   the entered search string
     * @param query
     *            the SQL query
     * @return the resulting list of courses
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * @throws ParseException
     *             if any error occurred during the parsing of the date  
     * 
     * @author Patrick Cretu
     */
    private static List&lt;Course&gt; getCourses(java.sql.Connection conn, int limit,
	    int offset, String searchString, String query, boolean isDate)
	    throws InvalidDBTransferException {
<span class="fc" id="L619">		List&lt;Course&gt; result = null;</span>
	
<span class="fc" id="L621">		try (PreparedStatement stmt = conn.prepareStatement(query)) {</span>
	
<span class="pc bpc" id="L623" title="1 of 2 branches missed.">		    if (isDate) {</span>
<span class="nc" id="L624">				SimpleDateFormat format = new SimpleDateFormat(&quot;dd.MM.yyyy&quot;);</span>
<span class="nc" id="L625">				Date parsed = format.parse(searchString);</span>
<span class="nc" id="L626">				java.sql.Date date = new java.sql.Date(parsed.getTime());</span>
<span class="nc" id="L627">				stmt.setDate(1, date);</span>
<span class="nc" id="L628">		    } else {</span>
<span class="fc" id="L629">				String search = &quot;%&quot; + searchString + &quot;%&quot;;</span>
<span class="fc" id="L630">				stmt.setString(1, search);</span>
		    }
<span class="fc" id="L632">		    stmt.setInt(2, limit);</span>
<span class="fc" id="L633">		    stmt.setInt(3, offset);</span>
	
<span class="fc" id="L635">		    try (ResultSet rst = stmt.executeQuery()) {</span>
<span class="fc" id="L636">		    	result = getResult(rst);</span>
<span class="pc bpc" id="L637" title="7 of 8 branches missed.">		    }</span>
		    
<span class="pc bpc" id="L639" title="7 of 8 branches missed.">		} catch (SQLException e) {</span>
<span class="nc" id="L640">		    throw new InvalidDBTransferException(&quot;SQL Exception occoured &quot; +</span>
		    		&quot;during getCoursesInPeriod(java.sql.Connection conn, &quot; +
		    		&quot;int limit, int offset, String searchString, &quot; +
<span class="nc" id="L643">		    		&quot;String query)&quot;, e);</span>
<span class="nc" id="L644">		} catch (ParseException e) {</span>
<span class="nc" id="L645">		    throw new InvalidDBTransferException(&quot;SQL Exception occoured &quot; +</span>
		    		&quot;during countCourses(java.sql.Connection conn,&quot; +
					&quot;String query, String searchString, boolean isDate)&quot;);
		}
<span class="fc" id="L649">		return result;</span>
    }

    
    
    
    /**
     * Retrieves and subsequently returns the courses within the passed result
     * set.
     * 
     * @param rst
     *          the result set containing the courses
     * @return the list of resulting courses
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * 
     * @author Patrick Cretu
     */
    private static List&lt;Course&gt; getResult(ResultSet rst)
	    throws InvalidDBTransferException {
<span class="fc" id="L669">		List&lt;Course&gt; result = new ArrayList&lt;Course&gt;();</span>
		try {
<span class="fc" id="L671">		    int cols = rst.getMetaData().getColumnCount();</span>
	
<span class="fc bfc" id="L673" title="All 2 branches covered.">		    while (rst.next()) {</span>
<span class="fc" id="L674">				int i = 1;</span>
<span class="fc" id="L675">				List&lt;Object&gt; tuple = new ArrayList&lt;Object&gt;();</span>
<span class="fc" id="L676">				Course course = new Course();</span>
<span class="fc bfc" id="L677" title="All 2 branches covered.">				while (i &lt;= cols) {</span>
<span class="fc" id="L678">				    Object o = rst.getObject(i);</span>
<span class="fc" id="L679">				    tuple.add(o);</span>
<span class="fc" id="L680">				    i++;</span>
				}
<span class="fc" id="L682">				setProperties(course, tuple);</span>
<span class="fc" id="L683">				result.add(course);</span>
		    }
<span class="fc bfc" id="L685" title="All 2 branches covered.">		    if (!result.isEmpty()) {</span>
<span class="fc" id="L686">		    	return result;</span>
		    }
<span class="nc" id="L688">		} catch (SQLException e) {</span>
<span class="nc" id="L689">		    throw new InvalidDBTransferException(&quot;SQL Exception occoured &quot; +</span>
<span class="nc" id="L690">		    		&quot;during getResult(ResultSet rst)&quot;, e);</span>
		}
<span class="fc" id="L692">		return null;</span>
    }

    /**
     * Sets the properties of the passed course object.
     * 
     * @param course
     *           the course object
     * @param tuple
     *            the list of properties
     * 
     * @author Patrick Cretu
     */
    private static void setProperties(Course course, List&lt;Object&gt; tuple) {
<span class="fc" id="L706">		course.setCourseID((Integer) tuple.get(0));</span>
<span class="fc" id="L707">		course.setTitle((String) tuple.get(1));</span>
<span class="fc" id="L708">		course.setMaxUsers((Integer) tuple.get(2));</span>
<span class="fc" id="L709">		course.setStartdate((Date) tuple.get(3));</span>
<span class="fc" id="L710">		course.setEnddate((Date) tuple.get(4));</span>
<span class="fc" id="L711">    }</span>

    /**
     * Returns a list of users which are leaders of the course with the passed
     * course ID.
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param courseID
     *            the course's ID
     * @return the list of users containing the course's leaders, or null if the
     *         course has no course leaders
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * @author Ricky Strohmeier
     */
    public static List&lt;User&gt; getLeaders(Transaction trans, int courseID)
	    throws InvalidDBTransferException {
<span class="fc" id="L730">	ArrayList&lt;User&gt; leaders = new ArrayList&lt;User&gt;();</span>

<span class="fc" id="L732">	String leadersQuery = &quot;SELECT \&quot;name\&quot;, \&quot;first_name\&quot;, \&quot;email\&quot;, \&quot;id\&quot; FROM &quot;</span>
		+ &quot;\&quot;users\&quot; WHERE id IN &quot;
		+ &quot;(SELECT course_instructor_id FROM \&quot;course_instructors\&quot; &quot;
		+ &quot;WHERE course_id = ?)&quot;;

<span class="fc" id="L737">	Connection connection = (Connection) trans;</span>
<span class="fc" id="L738">	java.sql.Connection conn = connection.getConn();</span>
<span class="fc" id="L739">	PreparedStatement statement = null;</span>
	ResultSet resultSet;

	try {
<span class="fc" id="L743">	    statement = conn.prepareStatement(leadersQuery);</span>
<span class="fc" id="L744">	    statement.setInt(1, courseID);</span>
<span class="fc" id="L745">	    resultSet = statement.executeQuery();</span>

<span class="fc bfc" id="L747" title="All 2 branches covered.">	    while (resultSet.next()) {</span>
<span class="fc" id="L748">		User leader = new User();</span>

<span class="pc bpc" id="L750" title="1 of 2 branches missed.">		if (resultSet.getString(&quot;name&quot;) != null) {</span>
<span class="fc" id="L751">		    leader.setLastname(resultSet.getString(&quot;name&quot;));</span>
<span class="fc" id="L752">		} else {</span>
<span class="nc" id="L753">		    leader.setLastname(&quot;geheim&quot;);</span>
		}

<span class="pc bpc" id="L756" title="1 of 2 branches missed.">		if (resultSet.getString(&quot;first_name&quot;) != null) {</span>
<span class="fc" id="L757">		    leader.setFirstname(resultSet.getString(&quot;first_name&quot;));</span>
<span class="fc" id="L758">		} else {</span>
<span class="nc" id="L759">		    leader.setFirstname(&quot;geheim&quot;);</span>
		}
<span class="fc" id="L761">		leader.setEmail(resultSet.getString(&quot;email&quot;));</span>
<span class="fc" id="L762">		leader.setUserId(resultSet.getInt(&quot;id&quot;));</span>
<span class="fc" id="L763">		leaders.add(leader);</span>
	    }
<span class="fc" id="L765">	    statement.close();</span>
<span class="fc" id="L766">	    resultSet.close(); </span>
<span class="pc" id="L767">	} catch (SQLException e) {</span>
<span class="nc" id="L768">	    LogHandler.getInstance().error(</span>
<span class="nc" id="L769">		    &quot;Error occoured in getLeaders from CourseDAO&quot;);</span>
<span class="nc" id="L770">	    throw new InvalidDBTransferException();</span>
	}
<span class="fc" id="L772">	return leaders;</span>
    }

    /**
     * Returns a course assigned to the specified ID.
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param courseID
     *            the course's ID
     * @return the course assigned to the course ID, or null if no such course
     *         was found
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * @author Ricky Strohmeier
     */
    public static Course getCourse(Transaction trans, int courseID)
	    throws InvalidDBTransferException {
<span class="fc" id="L791">	Course course = new Course();</span>
<span class="fc" id="L792">	String courseQuery = &quot;SELECT * FROM \&quot;courses\&quot; WHERE id = ?&quot;;</span>

<span class="fc" id="L794">    	Connection connection = (Connection) trans;</span>
<span class="fc" id="L795">    	java.sql.Connection conn = connection.getConn();</span>
<span class="fc" id="L796">    	PreparedStatement statement = null;</span>
<span class="fc" id="L797">    	ResultSet resultSet = null;</span>
    
    	try {
<span class="fc" id="L800">    	    statement = conn.prepareStatement(courseQuery);</span>
<span class="fc" id="L801">    	    statement.setInt(1, courseID);</span>
<span class="fc" id="L802">    	    resultSet = statement.executeQuery();</span>
<span class="fc" id="L803">    	    resultSet.next();</span>
<span class="fc" id="L804">    	    course.setTitle(resultSet.getString(&quot;title&quot;));</span>
<span class="fc" id="L805">    	    course.setMaxUsers(resultSet.getInt(&quot;max_participants&quot;));</span>
<span class="fc" id="L806">    	    course.setStartdate(resultSet.getDate(&quot;start_date&quot;));</span>
<span class="fc" id="L807">    	    course.setEnddate(resultSet.getDate(&quot;end_date&quot;));</span>
<span class="fc" id="L808">    	    course.setDescription(resultSet.getString(&quot;description&quot;));</span>
<span class="fc" id="L809">    	    course.setCourseID(resultSet.getInt(&quot;id&quot;));</span>
<span class="fc" id="L810">    	    course.setCourseImage(resultSet.getBytes(&quot;image&quot;));</span>
<span class="fc" id="L811">    	    statement.close();</span>
<span class="fc" id="L812">    	    resultSet.close();</span>
<span class="pc" id="L813">    	} catch (SQLException e) {</span>
<span class="nc" id="L814">    	    LogHandler.getInstance().error(</span>
<span class="nc" id="L815">    		    &quot;Error occoured in getCourse from CourseDAO&quot;);</span>
<span class="nc" id="L816">    	    throw new InvalidDBTransferException();</span>
    	}
<span class="fc" id="L818">    	return course;</span>
    }

    /**
     * Returns a list of courses which the user with the passed ID participates
     * in.
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param userID
     *            the user's ID
     * @return the list of courses which the user participates in, or null if
     *         the user doesn't participate in any course
     * 
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     *            
     * @author Fuchs Tobias
     */
    @SuppressWarnings(&quot;deprecation&quot;)
    public static List&lt;Course&gt; getCoursesOf(Transaction trans,
	    PaginationData pagination, int userID)
	    throws InvalidDBTransferException {
	
<span class="fc" id="L843">	String direction = pagination.getSortDirection().toString();</span>
<span class="fc" id="L844">	List&lt;Course&gt; coursesOf = new ArrayList&lt;Course&gt;();</span>
	
	//Formats the SQL - Statement
<span class="fc" id="L847">	String getMyCoursesQuery = String.format(GET_MY_COURSES,</span>
<span class="fc" id="L848">		pagination.getSortColumn(), direction);</span>
	
	
<span class="fc" id="L851">	Connection connection = (Connection) trans;</span>
<span class="fc" id="L852">	java.sql.Connection conn = connection.getConn();</span>

	//Calculates the offset
<span class="fc" id="L855">	int calculateOffset = pagination.getElementsPerPage()</span>
<span class="fc" id="L856">		* pagination.getCurrentPageNumber();</span>
	
	//Fetch the courses of a user
<span class="fc" id="L859">	try (PreparedStatement stmt = conn.prepareStatement(getMyCoursesQuery)) {</span>

<span class="fc" id="L861">	    stmt.setInt(1, userID);</span>
<span class="fc" id="L862">	    stmt.setInt(2, pagination.getElementsPerPage());</span>
<span class="fc" id="L863">	    stmt.setInt(3, calculateOffset);</span>
	   
<span class="fc" id="L865">	    try(ResultSet fetchedCourses = stmt.executeQuery()){</span>
	    
		Timestamp stamp;
		Date date;
		Course fetchedCourse;
		CourseUnit courseUnit;
		Address unitAddress;
		// Fills the list coursesOf with courses from the database.
		// At this time only id an title is set
<span class="pc bpc" id="L874" title="1 of 2 branches missed.">		while (fetchedCourses.next()) {</span>
<span class="nc" id="L875">		    fetchedCourse = new Course();</span>
<span class="nc" id="L876">		    courseUnit = new CourseUnit();</span>
		    
<span class="nc" id="L878">		    fetchedCourse.setCourseID(fetchedCourses.getInt(&quot;id&quot;));</span>
		
<span class="nc bnc" id="L880" title="All 2 branches missed.">		    if (fetchedCourses.getString(&quot;title&quot;) != null) {</span>
<span class="nc" id="L881">			fetchedCourse.setTitle(fetchedCourses.getString(&quot;title&quot;));</span>
<span class="nc" id="L882">		    } else {</span>
<span class="nc" id="L883">			fetchedCourse.setTitle(&quot;Nicht angegeben&quot;);</span>
		    }
		
		    
<span class="nc" id="L887">		    stamp = fetchedCourses.getTimestamp(&quot;start_time&quot;);</span>
<span class="nc bnc" id="L888" title="All 2 branches missed.">		    if (stamp != null) {</span>
<span class="nc" id="L889">			date = new Date(stamp.getYear(),</span>
<span class="nc" id="L890">				stamp.getMonth(),</span>
<span class="nc" id="L891">				stamp.getDate(), </span>
<span class="nc" id="L892">				stamp.getHours(),</span>
<span class="nc" id="L893">				stamp.getMinutes());</span>
<span class="nc" id="L894">		    courseUnit.setStartime(date);</span>
		    }
		    
<span class="nc" id="L897">		    unitAddress = new Address();</span>
<span class="nc bnc" id="L898" title="All 2 branches missed.">		    if(fetchedCourses.getString(&quot;location&quot;)!= null){</span>
<span class="nc" id="L899">			    unitAddress.setLocation(</span>
<span class="nc" id="L900">				    fetchedCourses.getString(&quot;location&quot;));</span>
<span class="nc" id="L901">		    }</span>
		    else{
<span class="nc" id="L903">			    unitAddress.setLocation(&quot;Nicht angegeben&quot;);</span>
		    }
<span class="nc" id="L905">		courseUnit.setAddress(unitAddress);</span>
<span class="nc" id="L906">		fetchedCourse.setNextCourseUnit(courseUnit);</span>
<span class="nc" id="L907">		coursesOf.add(fetchedCourse);</span>
	    }
<span class="pc bpc" id="L909" title="7 of 8 branches missed.">	  }</span>
<span class="pc bpc" id="L910" title="7 of 8 branches missed.">	} catch (SQLException e) {</span>
<span class="nc" id="L911">	    LogHandler.getInstance().error(&quot;Error occoured during fetching&quot; </span>
	                     + &quot; the next set of courses of a user.&quot;);
<span class="nc" id="L913">	    throw new InvalidDBTransferException();</span>
	}
<span class="fc" id="L915">	return coursesOf;</span>
    }

    /**
     * Returns the number of courses which the user with the passed ID
     * participates in.
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param userID
     *            the user's ID
     * @return the number of courses the user participates in
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     *             
     * @author Fuchs Tobias
     */
    public static int getNumberOfMyCourses(Transaction trans, int userID)
	    throws InvalidDBTransferException {
<span class="fc" id="L935">	int numberOfCourses = 0;</span>
	
<span class="fc" id="L937">	Connection connection = (Connection) trans;</span>
<span class="fc" id="L938">	java.sql.Connection conn = connection.getConn();</span>

<span class="fc" id="L940">	try (PreparedStatement  stmt = conn.prepareStatement(COUNT_MY_COURSES)) {</span>
<span class="fc" id="L941">	    stmt.setInt(1, userID);</span>
	    
<span class="fc" id="L943">	    try(ResultSet resultSet = stmt.executeQuery()){</span>
<span class="fc" id="L944">	    resultSet.next();</span>
<span class="fc" id="L945">	    numberOfCourses = resultSet.getInt(1);</span>
<span class="pc bpc" id="L946" title="7 of 8 branches missed.">	    }</span>
	    
<span class="pc bpc" id="L948" title="7 of 8 branches missed.">	} catch (SQLException e) {</span>
	    LogHandler
<span class="nc" id="L950">		    .getInstance()</span>
<span class="nc" id="L951">		    .error(&quot;Error occoured during fetching the number of&quot; </span>
			    + &quot; courses of a certain user.&quot;);
<span class="nc" id="L953">	    throw new InvalidDBTransferException();</span>
	}
<span class="fc" id="L955">	return numberOfCourses;</span>
    }

    /**
     * Updates a course stored in the database. The course's attributes are
     * replaced by the ones of the passed course.
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param course
     *            the course to be updated
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * @author Ricky Strohmeier
     */
    public static void updateCourse(Transaction trans, Course course)
	    throws InvalidDBTransferException {
<span class="fc" id="L973">        String emptyString = new String(&quot;nothing entered&quot;);</span>
<span class="fc" id="L974">        java.sql.Date emptyDate = new java.sql.Date(0);</span>
<span class="fc" id="L975">        int emptyNumber = 0;</span>

<span class="fc" id="L977">    	Connection connection = (Connection) trans;</span>
<span class="fc" id="L978">    	java.sql.Connection conn = connection.getConn();</span>

<span class="fc" id="L980">    	String courseQuery = &quot;UPDATE \&quot;courses\&quot; &quot;</span>
    		+ &quot;SET description = ?, max_participants = ?, start_date = ?, end_date = ? &quot;
    		+ &quot;WHERE id = ?&quot;;
    
<span class="fc" id="L984">    	try(PreparedStatement statement = conn.prepareStatement(courseQuery)) {</span>
<span class="pc bpc" id="L985" title="1 of 2 branches missed.">    	    if (!course.getDescription().equals(null)) {</span>
<span class="fc" id="L986">    	        statement.setString(1, course.getDescription());    	        </span>
<span class="fc" id="L987">    	    } else {</span>
<span class="nc" id="L988">    	        statement.setString(1, emptyString);</span>
    	    }

<span class="pc bpc" id="L991" title="1 of 2 branches missed.">    	    if (course.getMaxUsers() != null) {</span>
<span class="fc" id="L992">    	        statement.setInt(2, course.getMaxUsers());    	        </span>
<span class="fc" id="L993">    	    } else {</span>
<span class="nc" id="L994">    	        statement.setInt(2, emptyNumber);</span>
    	    }

<span class="pc bpc" id="L997" title="1 of 2 branches missed.">    	    if (course.getStartdate() != null) {</span>
<span class="fc" id="L998">    	        java.sql.Date startDate = new java.sql.Date(course.getStartdate().getTime());</span>
<span class="fc" id="L999">    	        statement.setDate(3, startDate);    	        </span>
<span class="fc" id="L1000">    	    } else {</span>
<span class="nc" id="L1001">    	        statement.setDate(3, emptyDate);</span>
    	    }

<span class="pc bpc" id="L1004" title="1 of 2 branches missed.">    	    if (course.getEnddate() != null) {</span>
<span class="fc" id="L1005">        	    java.sql.Date endDate = new java.sql.Date(course.getEnddate().getTime());</span>
<span class="fc" id="L1006">        	    statement.setDate(4, endDate);</span>
<span class="fc" id="L1007">    	    } else {</span>
<span class="nc" id="L1008">    	        statement.setDate(4, emptyDate);</span>
    	    }

<span class="pc bpc" id="L1011" title="1 of 2 branches missed.">    	    if (course.getCourseID() != 0) {</span>
<span class="fc" id="L1012">    	        statement.setInt(5, course.getCourseID());</span>
<span class="fc" id="L1013">    	    } else {</span>
<span class="nc" id="L1014">    	        statement.setInt(5, emptyNumber);</span>
    	    }

<span class="fc" id="L1017">    	    statement.executeUpdate();</span>
<span class="pc bpc" id="L1018" title="7 of 8 branches missed.">    	} catch (SQLException e) {</span>
<span class="nc" id="L1019">    	    LogHandler.getInstance().error(&quot;SQL Exception occoured in updateCourse of CourseDAO&quot;);</span>
<span class="nc" id="L1020">    	    throw new InvalidDBTransferException();</span>
    	}
<span class="fc" id="L1022">    }</span>

    /**
     * Deletes a course which is assigned to the passed ID.
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param courseID
     *            the ID of the course to be deleted
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * 
     * @author Katharina H�lzl
     */
    public static boolean deleteCourse(Transaction trans, int courseID)
	    throws InvalidDBTransferException {

<span class="nc" id="L1040">	boolean successful = false;</span>

	// Prepare SQL- Request and database connection.
<span class="nc" id="L1043">	Connection connection = (Connection) trans;</span>
<span class="nc" id="L1044">	java.sql.Connection conn = connection.getConn();</span>

<span class="nc" id="L1046">	String sql = &quot;DELETE FROM \&quot;courses\&quot; &quot;</span>
	           + &quot; WHERE id = ?&quot;;
	
	// catch potential SQL-Injection
<span class="nc" id="L1050">	try (PreparedStatement pS = conn.prepareStatement(sql)) {</span>
<span class="nc" id="L1051">	    pS.setInt(1, courseID);</span>

	    // execute preparedStatement, return resultSet as a list
	    // (here one entry in the list because the user id is unique)
<span class="nc bnc" id="L1055" title="All 2 branches missed.">	    if (pS.executeUpdate() == 1) {</span>
<span class="nc" id="L1056">		successful = true;</span>
<span class="nc" id="L1057">	    } else {</span>
<span class="nc" id="L1058">		successful = false;</span>
	    }
<span class="nc bnc" id="L1060" title="All 8 branches missed.">	} catch (SQLException e) {</span>
<span class="nc" id="L1061">	    throw new InvalidDBTransferException(</span>
<span class="nc" id="L1062">	                                &quot;Error occured during deleteCourse&quot;, e);</span>

	}
<span class="nc" id="L1065">	return successful;</span>
    }

    /**
     * Adds a user to a course's list of participants.
     * &lt;p&gt;
     * A tuple of the user's ID and the course's ID is added to the table
     * containing course participants in the database.
     * &lt;/p&gt;
     * 
     * 
     * @author Sebastian
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param userID
     *            the user's ID
     * @param courseID
     *            the course's ID
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     */
    public static void addUserToCourse(Transaction trans, int userID,
	    int courseID) throws InvalidDBTransferException {

<span class="nc" id="L1090">        Connection connection = (Connection) trans;</span>
<span class="nc" id="L1091">        java.sql.Connection conn = connection.getConn();</span>

<span class="nc" id="L1093">        String addUserToCourse = &quot;INSERT INTO \&quot;course_participants\&quot; (participant_id,course_id) VALUES (?,?)&quot;;</span>

        try {
<span class="nc" id="L1096">            setRelationMethode(userID, courseID, conn, addUserToCourse);</span>

<span class="nc" id="L1098">	        } catch (SQLException e) {</span>
	    
<span class="nc" id="L1100">	            throw new InvalidDBTransferException(&quot;Error occured during addUserToCOurse&quot;, e);</span>
	        }
<span class="nc" id="L1102">    }</span>

    /**
     * Removes a user from a course's list of participants.
     * &lt;p&gt;
     * The tuple of the user's ID and the course's ID is removed from the table
     * of course participants in the database.
     * &lt;/p&gt;
     * 
     * @author Sebastian
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param userID
     *            the user's ID
     * @param courseID
     *            the course's ID
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     */
    public static void removeUserFromCourse(Transaction trans, int userID,
	    int courseID) throws InvalidDBTransferException {

<span class="nc" id="L1125">        Connection connection = (Connection) trans;</span>
<span class="nc" id="L1126">        java.sql.Connection conn = connection.getConn();</span>

<span class="nc" id="L1128">        String removeUserFromCourse = &quot;DELETE FROM \&quot;course_participants\&quot; WHERE participant_id = ? AND course_id = ?&quot;;</span>

        try {
<span class="nc" id="L1131">            setRelationMethode(userID, courseID, conn, removeUserFromCourse);</span>

<span class="nc" id="L1133">        } catch (SQLException e) {           </span>
<span class="nc" id="L1134">            throw new InvalidDBTransferException(&quot;Error occured while trying to delete User:&quot; + userID</span>
<span class="nc" id="L1135">                + &quot; from course:&quot; + courseID, e);</span>
        }

<span class="nc" id="L1138">    }</span>

    /**
     * Adds a user to a course's list of course leaders.
     * &lt;p&gt;
     * A tuple of the user's ID and the course's ID is added to the table
     * containing course leaders in the database.
     * &lt;/p&gt;
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param userID
     *            the user's ID
     * @param courseID
     *            the course's ID
     * @return true if the course leader could be add to the course, else false
     * @throws InvalidDBTransferException
     *             if any error occurred during the execution of the method
     * 
     * @author Katharina H�lzl
     */
    public static boolean addLeaderToCourse(Transaction trans, int userID,
	    int courseID) throws InvalidDBTransferException {

<span class="fc" id="L1163">	boolean successful = false;</span>

	// Prepare SQL- INSERT and database connection.

<span class="fc" id="L1167">	Connection connection = (Connection) trans;</span>
<span class="fc" id="L1168">	java.sql.Connection conn = connection.getConn();</span>

<span class="fc" id="L1170">	String sql = &quot;INSERT into \&quot;course_instructors\&quot; &quot;</span>
	            + &quot;(course_instructor_id, course_id) &quot; 
	            + &quot;values (?, ?)&quot;;

	// catch potential SQL-Injection
	try {

<span class="pc bpc" id="L1177" title="1 of 2 branches missed.">	    if (setRelationMethode(userID, courseID, conn, sql) == 1) {</span>
<span class="fc" id="L1178">		successful = true;</span>
<span class="fc" id="L1179">	    } else {</span>
<span class="nc" id="L1180">		successful = false;</span>
	    }

<span class="nc" id="L1183">	} catch (SQLException e) {</span>
<span class="nc" id="L1184">	    throw new InvalidDBTransferException(</span>
<span class="nc" id="L1185">	                          &quot;Error occured during addLeaderToCourse&quot;, e);</span>

	}
<span class="fc" id="L1188">	return successful;</span>
    }

    /**
     * Removes a course leader from a course's list of course leaders.
     * &lt;p&gt;
     * The tuple of the course leader's ID and the course's ID is removed from
     * the table of course leaders in the database.
     * &lt;/p&gt;
     * 
     * @param trans
     *            the Transaction object which contains the connection to the
     *            database
     * @param userID
     *            the course leader's ID
     * @param courseID
     *            the course's ID
     * @throws InvalidDBTransferException
     * @return true if the course leader could be removed, else false. if any
     *         error occurred during the execution of the method
     * 
     * @author Katharina H�lzl
     */
    public static boolean removeLeaderFromCourse(Transaction trans, int userID,
	    int courseID) throws InvalidDBTransferException {

<span class="nc" id="L1214">	boolean successful = false;</span>
	// Prepare SQL- request and database connection.

<span class="nc" id="L1217">	Connection connection = (Connection) trans;</span>
<span class="nc" id="L1218">	java.sql.Connection conn = connection.getConn();</span>

<span class="nc" id="L1220">	String sql = &quot;DELETE FROM \&quot;course_instructors\&quot; &quot;</span>
	           + &quot;WHERE course_id = ? &quot;
	           + &quot;AND course_instructor_id = ?&quot;;
	
	// catch potential SQL-Injection
	try {
<span class="nc bnc" id="L1226" title="All 2 branches missed.">	    if (setRelationMethode(courseID, userID, conn, sql) == 1) {</span>
<span class="nc" id="L1227">		successful = true;</span>
<span class="nc" id="L1228">	    } else {</span>
<span class="nc" id="L1229">		successful = false;</span>
	    }

<span class="nc" id="L1232">	} catch (SQLException e) {</span>
<span class="nc" id="L1233">	    throw new InvalidDBTransferException(</span>
<span class="nc" id="L1234">	                      &quot;Error occured during removeLeaderFromCourse&quot;, e);</span>

	}
<span class="nc" id="L1237">	return successful;</span>
    }

    /**
     * Returns the Number of Participants of that Course
     * 
     * @author Sebastian
     * @param trans
     * @param courseID
     * @return Number of Participants as Integer
     */
    public static Integer getNumberOfParticipants(Transaction trans,
	    int courseID) {
        
<span class="fc" id="L1251">        Connection connection = (Connection) trans;</span>
<span class="fc" id="L1252">        java.sql.Connection conn = connection.getConn();</span>
<span class="fc" id="L1253">        String countSQLstat = &quot;SELECT COUNT(*) FROM \&quot;course_participants\&quot; WHERE course_id=?&quot;;</span>
        
<span class="fc" id="L1255">        try(PreparedStatement pS = conn.prepareStatement(countSQLstat)) {</span>
	    
<span class="fc" id="L1257">            pS.setInt(1, courseID);           </span>
<span class="fc" id="L1258">            try(ResultSet resultSet = pS.executeQuery()){</span>
                
<span class="fc" id="L1260">                resultSet.next();</span>
<span class="fc" id="L1261">                int numberOfParticipants = resultSet.getInt(1);</span>
<span class="pc" id="L1262">                return numberOfParticipants;  </span>
<span class="pc bpc" id="L1263" title="7 of 8 branches missed.">            }</span>
<span class="pc bpc" id="L1264" title="7 of 8 branches missed.">        } catch (SQLException e) {</span>
            
<span class="nc" id="L1266">            throw new InvalidDBTransferException(&quot;Exception occured during getNumberOfParticipants&quot;, e);</span>
        }

    }

    /**
     * 
     * Adds a User to the User_Inform Table of the Database. 
     * 
     * @author Sebastian
     * @param trans
     * @param userID
     * @param courseID
     */
    public static void addUserToInformUser(Transaction trans, int userID,
	    int courseID) {

<span class="nc" id="L1283">        Connection connection = (Connection) trans;</span>
<span class="nc" id="L1284">        java.sql.Connection conn = connection.getConn();</span>
<span class="nc" id="L1285">        String addUserToInformUser = &quot;INSERT INTO \&quot;inform_users\&quot; (user_id,course_id) VALUES (?,?)&quot;;</span>
        
        try {
<span class="nc" id="L1288">            setRelationMethode(userID, courseID, conn, addUserToInformUser);</span>

        
<span class="nc" id="L1291">        } catch (SQLException e) {</span>
<span class="nc" id="L1292">            throw new InvalidDBTransferException(&quot;Exception occured during addUserToInformUser&quot;, e);</span>
        }
<span class="nc" id="L1294">    }</span>

    /**
     * This DAO Methode removes a User from The Inform_Users Table.(For example when the Users
     * leaves the course where he signed up for Course News)
     * 
     * @author Sebastian Schwarz
     * @param trans
     * @param userID
     * @param courseID
     */
    public static void removeUserToInformUser(Transaction trans, int userID,
	    int courseID) {

<span class="nc" id="L1308">        Connection connection = (Connection) trans;</span>
<span class="nc" id="L1309">        java.sql.Connection conn = connection.getConn();</span>

<span class="nc" id="L1311">        String removeUserToInformUser = &quot;DELETE FROM \&quot;inform_users\&quot; WHERE user_id=? AND course_id=?&quot;;</span>
	
        try {
<span class="nc" id="L1314">            setRelationMethode(userID, courseID, conn, removeUserToInformUser);</span>
            
<span class="nc" id="L1316">	    } catch (SQLException e) {	    </span>
<span class="nc" id="L1317">	        throw new InvalidDBTransferException(&quot;Exception occured during RemoveUserToInformUser&quot;, e);</span>
	    }        
<span class="nc" id="L1319">    }</span>

    /**
     * This is a extracted Methode which sets the values and excute a simple sql command.
     * 
     * 
     * @author Sebastian
     * @param userID
     * @param courseID
     * @param conn
     * @param preparedStmt
     * @throws SQLException
     */
    static int setRelationMethode(int userID, int courseID,
	    java.sql.Connection conn, String preparedStmt) throws SQLException {
	
<span class="fc" id="L1335">        try(PreparedStatement pS = conn.prepareStatement(preparedStmt)){</span>
            
<span class="fc" id="L1337">            pS.setInt(1, userID);</span>
<span class="fc" id="L1338">            pS.setInt(2, courseID);</span>
<span class="fc" id="L1339">            int success = pS.executeUpdate();</span>
            
<span class="pc" id="L1341">            return success;</span>
<span class="pc bpc" id="L1342" title="7 of 8 branches missed.">        }			</span>
    }

    
    /**
     * Returns the Picture as Byte Array from the Database
     * 
     * 
     * @author Sebastian Schwarz
     * @param trans
     * @param courseID
     * @return picture 
     *              as byte Array
     */
    public static byte[] getImage(Transaction trans, int courseID) {
	
<span class="fc" id="L1358">        Connection connection = (Connection) trans;</span>
<span class="fc" id="L1359">        java.sql.Connection conn = connection.getConn();</span>
        byte[] picture;

<span class="fc" id="L1362">        String selectImage = &quot;SELECT image FROM \&quot;courses\&quot; WHERE id=?&quot;;</span>

<span class="fc" id="L1364">        try(PreparedStatement pS = conn.prepareStatement(selectImage)) {</span>
	    
<span class="fc" id="L1366">            pS.setInt(1, courseID);</span>
	    
<span class="fc" id="L1368">            try(ResultSet resultSet = pS.executeQuery()){</span>
	        
<span class="pc bpc" id="L1370" title="1 of 2 branches missed.">                if (resultSet.next()) {</span>
                    
<span class="fc" id="L1372">                    picture = resultSet.getBytes(&quot;image&quot;);  </span>
<span class="fc" id="L1373">                    return picture;</span>
	        } else {
	        	
	            //Returns null so that the HTTP Serlvet can load the dummy picutre
<span class="nc" id="L1377">	            return null;</span>
	        }  
<span class="pc bpc" id="L1379" title="9 of 10 branches missed.">	    }</span>
	    
<span class="pc bpc" id="L1381" title="9 of 10 branches missed.">	} catch (SQLException e) {</span>
	    
<span class="nc" id="L1383">	    throw new InvalidDBTransferException(&quot;Exception occured during &quot;</span>
<span class="nc" id="L1384">	            + &quot;loading course Picture from Database&quot;, e);</span>
	    }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>